<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Roll Tech P&L Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 240px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1421 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 12px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.4);
            transition: transform 0.3s ease;
        }
        .logo { text-align: center; padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .logo h1 { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 11px; color: var(--text-secondary); display: block; margin-top: 4px; letter-spacing: 0.5px; }
        .nav-section { margin-bottom: 20px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 10px; padding-left: 14px; font-weight: 700; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 14px; margin: 3px 0; border-radius: 10px;
            cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 13px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }

        /* ==================== MAIN CONTENT ==================== */
        .main-content { margin-left: var(--sidebar-width); padding: 20px 24px; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ==================== ALERTS BANNER ==================== */
        .alerts-banner {
            background: linear-gradient(135deg, #742a2a 0%, #9b2c2c 100%);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 20px;
            display: none;
        }
        .alerts-banner.active { display: block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(229,62,62,0.4); } 50% { box-shadow: 0 0 0 8px rgba(229,62,62,0); } }
        .alerts-banner h4 { color: #fed7d7; font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .alerts-banner ul { margin: 0; padding-left: 20px; font-size: 12px; color: #feb2b2; }
        .alerts-banner li { margin: 3px 0; }

        /* ==================== TOOLBAR ==================== */
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center;
            background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border);
        }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"] {
            background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 12px; color: white; font-size: 12px; cursor: pointer;
        }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn {
            background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .toolbar-btn.success { background: var(--success); border-color: var(--success); }
        .toolbar-spacer { flex: 1; }

        /* ==================== PAGE HEADER ==================== */
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ==================== STATS GRID ==================== */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%);
            border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
        }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .trend-arrow { font-size: 14px; }
        .trend-arrow.up { color: var(--success); }
        .trend-arrow.down { color: var(--danger); }

        /* ==================== CHARTS ==================== */
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .chart-wrapper.xlarge { height: 400px; }

        /* ==================== SEARCH BOX ==================== */
        .search-box {
            background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px;
            padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s;
        }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }

        /* ==================== TABLES ==================== */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white; padding: 12px 14px; text-align: left; font-weight: 600; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.8px; position: sticky; top: 0;
            white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.2s;
        }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 11px 14px; border-bottom: 1px solid var(--border); font-size: 12px; transition: background 0.15s; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table tr.clickable { cursor: pointer; }
        .data-table tr.clickable:hover td { background: rgba(49,130,206,0.15); }
        .data-table tr.selected td { background: rgba(49,130,206,0.25) !important; }
        .data-table tr.selected td:first-child { border-left: 3px solid var(--accent); padding-left: 11px; }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .clickable-cell { color: var(--accent); cursor: pointer; }
        .data-table .clickable-cell:hover { text-decoration: underline; }
        .scrollable-table { max-height: 420px; overflow-y: auto; overflow-x: auto; border-radius: 10px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Heat Map Styling */
        .heatmap-enabled .heat-cell { transition: background 0.2s; }
        .heat-critical { background: rgba(229,62,62,0.3) !important; }
        .heat-warning { background: rgba(214,158,46,0.2) !important; }
        .heat-good { background: rgba(56,161,105,0.2) !important; }

        /* Sparkline */
        .sparkline { width: 60px; height: 20px; display: inline-block; vertical-align: middle; }

        /* Favorite Star */
        .favorite-star { cursor: pointer; font-size: 14px; opacity: 0.3; transition: all 0.2s; margin-right: 6px; }
        .favorite-star:hover { opacity: 0.7; }
        .favorite-star.active { opacity: 1; color: var(--warning); }

        /* ==================== BADGES ==================== */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--purple) 0%, #6b46c1 100%); color: white; }
        .badge.forecast { background: linear-gradient(135deg, var(--orange) 0%, #c05621 100%); color: white; }
        .badge.target-achieved { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.net-profitable { background: linear-gradient(135deg, var(--accent) 0%, #2b6cb0 100%); color: white; }
        .badge.marginal-coverage { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.critical-loss { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }

        /* ==================== DRILLDOWNS ==================== */
        .drilldown-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%);
            border-radius: 14px; padding: 20px; border: 1px solid var(--accent);
            margin-bottom: 20px; display: none; box-shadow: 0 8px 32px rgba(49,130,206,0.15);
        }
        .drilldown-section.active { display: block; animation: fadeIn 0.3s ease; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .drilldown-header .subtitle { color: var(--accent); font-size: 13px; margin-top: 3px; font-weight: 500; }
        .close-btn { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .close-btn:hover { transform: scale(1.05); }
        .back-btn { background: var(--bg-dark); color: white; border: 1px solid var(--border); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); }
        .summary-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 14px 16px; border-radius: 10px; min-width: 110px; border: 1px solid var(--border); }
        .summary-item .label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; font-weight: 700; letter-spacing: 0.8px; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        .breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 12px; color: var(--text-secondary); flex-wrap: wrap; }
        .breadcrumb span { color: var(--accent); font-weight: 600; }

        /* ==================== TABS ==================== */
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }

        /* ==================== BOM EXPLORER ==================== */
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }

        /* ==================== NOTES MODAL ==================== */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: 14px; padding: 24px; max-width: 500px; width: 90%; border: 1px solid var(--border); }
        .modal h3 { margin-bottom: 16px; font-size: 18px; }
        .modal textarea { width: 100%; height: 120px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: white; font-size: 13px; resize: vertical; }
        .modal-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }

        /* ==================== GRID LAYOUTS ==================== */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

        /* ==================== LOADING ==================== */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ==================== PRINT STYLES ==================== */
        @media print {
            body { background: white !important; color: black !important; font-size: 12px; }
            .sidebar, .mobile-header, .toolbar, .close-btn, .back-btn, .alerts-banner, .search-box { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 10px !important; }
            .page { display: block !important; page-break-after: always; }
            .chart-container, .stat-card, .drilldown-section { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; }
            .data-table th { background: #e2e8f0 !important; color: black !important; }
            .data-table td { border-color: #ccc !important; }
            .positive { color: #22543d !important; }
            .negative { color: #c53030 !important; }
        }

        /* ==================== MOBILE STYLES ==================== */
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .mobile-header span { font-size: 10px; color: var(--text-secondary); }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
            .bom-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            :root { --sidebar-width: 260px; }
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .page-header h2 { font-size: 22px; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card { padding: 14px 16px; }
            .stat-card .value { font-size: 20px; }
            .stat-card .label { font-size: 9px; }
            .chart-wrapper { height: 220px; }
            .chart-wrapper.large, .chart-wrapper.xlarge { height: 280px; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-group { flex-wrap: wrap; }
            .toolbar-spacer { display: none; }
            .data-table th, .data-table td { padding: 10px 8px; font-size: 11px; }
            .scrollable-table { max-height: 350px; }
            .summary-row { gap: 8px; }
            .summary-item { padding: 10px 12px; min-width: 90px; }
            .summary-item .value { font-size: 16px; }
            .drilldown-section { padding: 16px; }
            .bom-selector { max-height: 300px; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stat-card { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; }
            .stat-card .label { margin-bottom: 0; }
            .stat-card .value { font-size: 18px; }
            .stat-card .sub { display: none; }
            .chart-header h3 { font-size: 14px; }
            .tabs { gap: 6px; }
            .tab { padding: 8px 12px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <div><h1>Roll Tech</h1><span>P&L Analytics</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="logo"><h1>Roll Tech</h1><span>P&L Analytics Dashboard</span></div>
        <div class="nav-section">
            <div class="nav-section-title">Reports</div>
            <div class="nav-item active" data-page="overview" onclick="navigateTo('overview')"><span class="icon">üìä</span> Dashboard Overview</div>
            <div class="nav-item" data-page="parts" onclick="navigateTo('parts')"><span class="icon">üîß</span> P/L by Part Number</div>
            <div class="nav-item" data-page="customers" onclick="navigateTo('customers')"><span class="icon">üë•</span> P/L by Customer</div>
            <div class="nav-item" data-page="dates" onclick="navigateTo('dates')"><span class="icon">üìÖ</span> P/L by Date</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">üìã</span> BOM Explorer</div>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="margin-top:18px; color:var(--text-secondary);">Loading data from Google Sheets...</p>
        </div>

        <!-- ALERTS BANNER -->
        <div class="alerts-banner" id="alertsBanner">
            <h4>‚ö†Ô∏è Critical Alerts</h4>
            <ul id="alertsList"></ul>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar" id="mainToolbar" style="display:none;">
            <div class="toolbar-group">
                <label>Date Range:</label>
                <input type="date" id="dateFrom" onchange="applyFilters()">
                <span style="color:var(--text-secondary);">to</span>
                <input type="date" id="dateTo" onchange="applyFilters()">
                <button class="toolbar-btn" onclick="clearDateFilter()">Clear</button>
            </div>
            <div class="toolbar-spacer"></div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="heatmapBtn" onclick="toggleHeatmap()">üå°Ô∏è Heat Map</button>
                <button class="toolbar-btn" id="favoritesBtn" onclick="toggleFavoritesOnly()">‚≠ê Favorites</button>
                <button class="toolbar-btn" onclick="exportToCSV()">üì• Export CSV</button>
                <button class="toolbar-btn" onclick="window.print()">üñ®Ô∏è Print</button>
                <button class="toolbar-btn" id="autoRefreshBtn" onclick="toggleAutoRefresh()">üîÑ Auto-Refresh</button>
            </div>
        </div>

        <!-- OVERVIEW PAGE -->
        <div id="overview" class="page">
            <div class="page-header">
                <div><h2>Dashboard Overview</h2><p>Complete profit and loss analysis for Roll Tech operations</p></div>
                <div class="last-updated"><div class="dot"></div><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value" id="statRevenue">$0</div><div class="sub" id="statOrderCount">0 orders</div></div>
                <div class="stat-card"><div class="label">Total Profit/Loss</div><div class="value" id="statPL">$0</div><div class="sub" id="statMargin">Margin: 0%</div></div>
                <div class="stat-card"><div class="label">Shipped P/L</div><div class="value" id="statShippedPL">$0</div><div class="sub" id="statShippedCount">0 shipped</div></div>
                <div class="stat-card"><div class="label">Forecasted P/L</div><div class="value" id="statForecastPL">$0</div><div class="sub" id="statForecastCount">0 pending</div></div>
            </div>
            <div class="grid-2">
                <div class="chart-container"><div class="chart-header"><h3>Top 10 Biggest Losses</h3></div><div class="chart-wrapper large"><canvas id="topPartsChart"></canvas></div></div>
                <div class="chart-container"><div class="chart-header"><h3>Customer P/L Distribution</h3></div><div class="chart-wrapper large"><canvas id="customerPieChart"></canvas></div></div>
            </div>
            <div class="chart-container"><div class="chart-header"><h3>Monthly P/L Trend</h3></div><div class="chart-wrapper"><canvas id="monthlyTrendChart"></canvas></div></div>
        </div>

        <!-- PARTS PAGE -->
        <div id="parts" class="page">
            <div class="page-header"><div><h2>P/L by Part Number</h2><p>Click on a part to see customer breakdown</p></div></div>
            <div class="chart-container"><div class="chart-header"><h3>All Parts P/L Analysis</h3></div><div class="chart-wrapper xlarge"><canvas id="allPartsChart"></canvas></div></div>
            <div class="chart-container">
                <div class="chart-header"><h3>Part Details</h3><input type="text" class="search-box" id="partsSearch" placeholder="Search parts..."></div>
                <div class="scrollable-table">
                    <table class="data-table" id="partsTable"><thead><tr>
                        <th data-sort="part" onclick="sortPartsTable('part')">RT Part # <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="qty" onclick="sortPartsTable('qty')">Total Qty <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="avgProfit" onclick="sortPartsTable('avgProfit')">Avg $/Part <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="pl" onclick="sortPartsTable('pl')">Total P/L <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="revenue" onclick="sortPartsTable('revenue')">Revenue <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="margin" onclick="sortPartsTable('margin')">Margin % <span class="sort-indicator">‚ñº</span></th>
                        <th>Trend</th>
                    </tr></thead><tbody id="partsTableBody"></tbody></table>
                </div>
            </div>
            <div id="partCustomerBreakdown" class="drilldown-section">
                <div class="drilldown-header">
                    <div><h3>üì¶ Customer Breakdown</h3><div class="subtitle" id="selectedPartTitle"></div></div>
                    <div><button class="toolbar-btn" onclick="openNotesModal()">üìù Add Note</button><button class="close-btn" onclick="closePartDrilldown()">‚úï Close</button></div>
                </div>
                <div id="partNotes" style="margin-bottom:12px;padding:10px;background:var(--bg-dark);border-radius:8px;font-size:12px;display:none;"></div>
                <div class="summary-row" id="partSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr><th>Customer</th><th>Qty</th><th>Sales Price</th><th>Contribution</th><th>Margin %</th><th>P/L</th><th>Revenue</th></tr></thead><tbody id="partCustomerTableBody"></tbody></table>
                </div>
            </div>
            <div id="partCustomerOrders" class="drilldown-section">
                <div class="drilldown-header">
                    <div><div class="breadcrumb">Part: <span id="bcPart"></span> ‚Ä∫ Customer: <span id="bcCust"></span></div><h3 id="partCustOrdersTitle">Order History</h3></div>
                    <div><button class="back-btn" onclick="backToPartCustomers()">‚Üê Back</button><button class="close-btn" onclick="closeAllPartDrilldowns()">‚úï Close All</button></div>
                </div>
                <div class="summary-row" id="partCustOrdersSummary"></div>
                <div id="priceHistory" style="margin-bottom:16px;"></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead><tbody id="partCustOrdersBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS PAGE -->
        <div id="customers" class="page">
            <div class="page-header"><div><h2>P/L by Customer</h2><p>Click on a customer to see product breakdown</p></div></div>
            <div class="chart-container">
                <div class="chart-header"><h3>All Customers</h3><input type="text" class="search-box" id="customersSearch" placeholder="Search customers..."></div>
                <div class="scrollable-table">
                    <table class="data-table" id="customersTable"><thead><tr>
                        <th data-sort="customer" onclick="sortCustomersTable('customer')">Customer <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="qty" onclick="sortCustomersTable('qty')">Quantity <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="pl" onclick="sortCustomersTable('pl')">P/L <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="revenue" onclick="sortCustomersTable('revenue')">Revenue <span class="sort-indicator">‚ñº</span></th>
                        <th data-sort="margin" onclick="sortCustomersTable('margin')">Margin <span class="sort-indicator">‚ñº</span></th>
                        <th>Trend</th>
                    </tr></thead><tbody id="customersTableBody"></tbody></table>
                </div>
            </div>
            <div id="customerProductBreakdown" class="drilldown-section">
                <div class="drilldown-header"><div><h3>üè≠ Product Breakdown</h3><div class="subtitle" id="selectedCustomerTitle"></div></div><button class="close-btn" onclick="closeCustomerDrilldown()">‚úï Close</button></div>
                <div class="summary-row" id="customerProductSummary"></div>
                <div class="scrollable-table"><table class="data-table"><thead><tr><th>Part Number</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Margin %</th><th>P/L</th><th>Revenue</th></tr></thead><tbody id="customerProductTableBody"></tbody></table></div>
            </div>
            <div id="customerPartOrders" class="drilldown-section">
                <div class="drilldown-header">
                    <div><div class="breadcrumb">Customer: <span id="bc2Customer"></span> ‚Ä∫ Part: <span id="bc2Part"></span></div><h3 id="partOrdersTitle">Order Details</h3></div>
                    <div><button class="back-btn" onclick="backToProducts()">‚Üê Back</button><button class="close-btn" onclick="closeAllCustomerDrilldowns()">‚úï Close All</button></div>
                </div>
                <div class="summary-row" id="partOrdersSummary"></div>
                <div class="scrollable-table"><table class="data-table"><thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead><tbody id="partOrdersTableBody"></tbody></table></div>
            </div>
        </div>

        <!-- DATES PAGE -->
        <div id="dates" class="page">
            <div class="page-header"><div><h2>P/L by Date</h2><p>Click on a month to see customer breakdown</p></div></div>
            <div class="chart-container"><div class="chart-header"><h3>Monthly P/L (Shipped vs Forecast)</h3></div><div class="chart-wrapper large"><canvas id="dateStackedChart"></canvas></div></div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly Breakdown</h3></div>
                <div class="scrollable-table"><table class="data-table"><thead><tr><th>Month</th><th>Status</th><th>Orders</th><th>Quantity</th><th>Revenue</th><th>P/L</th></tr></thead><tbody id="datesTableBody"></tbody></table></div>
            </div>
            <div id="monthlyDrilldown" class="drilldown-section">
                <div class="drilldown-header"><div><h3 id="monthDrilldownTitle">Period Details</h3></div><button class="close-btn" onclick="closeMonthDrilldown()">‚úï Close</button></div>
                <div class="summary-row" id="monthDrilldownSummary"></div>
                <div class="scrollable-table"><table class="data-table"><thead><tr><th>Customer</th><th>Orders</th><th>Quantity</th><th>Revenue</th><th>P/L</th><th>Margin</th></tr></thead><tbody id="monthCustomersTableBody"></tbody></table></div>
            </div>
            <div id="monthCustomerOrders" class="drilldown-section">
                <div class="drilldown-header">
                    <div><div class="breadcrumb">Period: <span id="bcMonth"></span> ‚Ä∫ Customer: <span id="bcCustomer"></span></div><h3 id="monthCustomerTitle">Orders</h3></div>
                    <div><button class="back-btn" onclick="backToMonthCustomers()">‚Üê Back</button><button class="close-btn" onclick="closeAllDateDrilldowns()">‚úï Close All</button></div>
                </div>
                <div class="summary-row" id="monthCustomerSummary"></div>
                <div class="scrollable-table"><table class="data-table"><thead><tr><th>Part</th><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th></tr></thead><tbody id="monthCustomerOrdersBody"></tbody></table></div>
            </div>
        </div>

        <!-- BOM PAGE -->
        <div id="bom" class="page">
            <div class="page-header"><div><h2>BOM Explorer</h2><p>Browse Bill of Materials for assemblies and parts</p></div></div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Select a Part</h3><input type="text" class="search-box" id="bomSearch" placeholder="Search parts..."></div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header"><h3 id="bomPartName">Select a part</h3><div class="category" id="bomCategory"></div></div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTES MODAL -->
    <div class="modal-overlay" id="notesModal">
        <div class="modal">
            <h3>üìù Notes for <span id="notesPartName"></span></h3>
            <textarea id="notesText" placeholder="Add notes about pricing changes, customer negotiations, etc..."></textarea>
            <div class="modal-actions">
                <button class="toolbar-btn" onclick="closeNotesModal()">Cancel</button>
                <button class="toolbar-btn success" onclick="saveNotes()">Save Note</button>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const CONFIG_GID = '912029812';
        
        let config = {}, ordersData = [], filteredData = [], bomFinalData = [], bomSubData = [], bomIndividualData = [], charts = {};
        let selectedMonth = null, selectedCustomer = null, selectedPart = null, currentBomTab = 'final';
        let partsTableData = [], partsSortField = 'pl', partsSortAsc = true;
        let customersTableData = [], customersSortField = 'pl', customersSortAsc = true;
        let heatmapEnabled = false, favoritesOnly = false, autoRefreshEnabled = false, autoRefreshInterval = null;
        let favorites = JSON.parse(localStorage.getItem('rtFavorites') || '{"parts":[],"customers":[]}');
        let notes = JSON.parse(localStorage.getItem('rtNotes') || '{}');

        // Utilities
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); const n = parseFloat(c); return isNaN(n) ? 0 : n; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const parseMonth = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return `${p[2].length===2?'20'+p[2]:p[2]}-${p[0].padStart(2,'0')}`; } else if (d.includes('-')) return d.substring(0,7); return null; };
        
        function getStatusBadge(s) {
            if (!s) return '<span class="badge">Unknown</span>';
            const l = s.toLowerCase();
            if (l === 'shipped') return '<span class="badge shipped">Shipped</span>';
            if (l === 'pending') return '<span class="badge pending">Pending</span>';
            if (l === 'staged') return '<span class="badge staged">Staged</span>';
            return `<span class="badge forecast">${s}</span>`;
        }
        
        function getContributionBadge(level) {
            if (!level) return '<span class="badge">-</span>';
            const l = level.toLowerCase();
            if (l.includes('target')) return '<span class="badge target-achieved">Target</span>';
            if (l.includes('net')) return '<span class="badge net-profitable">Profitable</span>';
            if (l.includes('marginal')) return '<span class="badge marginal-coverage">Marginal</span>';
            if (l.includes('critical')) return '<span class="badge critical-loss">Critical</span>';
            return `<span class="badge">${level}</span>`;
        }

        function getTrendArrow(current, previous) {
            if (previous === 0) return '';
            const change = ((current - previous) / Math.abs(previous)) * 100;
            if (Math.abs(change) < 5) return '<span class="trend-arrow" style="color:var(--text-secondary);">‚Üí</span>';
            return change > 0 ? '<span class="trend-arrow up">‚Üë</span>' : '<span class="trend-arrow down">‚Üì</span>';
        }

        function getHeatClass(value, type = 'pl') {
            if (!heatmapEnabled) return '';
            if (type === 'margin') {
                if (value < -20) return 'heat-critical';
                if (value < 0) return 'heat-warning';
                return 'heat-good';
            }
            if (value < -10000) return 'heat-critical';
            if (value < 0) return 'heat-warning';
            return 'heat-good';
        }

        // CSV Parsing
        function parseCSV(text) {
            const lines = text.split('\n'); if (lines.length < 2) return [];
            const headers = parseCSVLine(lines[0]).map(h => h.trim());
            return lines.slice(1).filter(l => l.trim()).map(line => {
                const values = parseCSVLine(line);
                const row = {};
                headers.forEach((h, i) => row[h] = (values[i] || '').trim());
                return row;
            });
        }
        function parseCSVLine(line) {
            const result = []; let current = '', inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (c === '"') inQuotes = !inQuotes;
                else if (c === ',' && !inQuotes) { result.push(current); current = ''; }
                else current += c;
            }
            result.push(current); return result;
        }
        async function fetchSheetData(gid) {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`);
            if (!r.ok) throw new Error(`Failed to fetch GID ${gid}`);
            return parseCSV(await r.text());
        }
        function parseColumnMappings(t) {
            if (!t) return {};
            const m = {};
            t.split(/[;\n]/).forEach(line => { const match = line.match(/(.+?)\s*‚Üí\s*(.+)/); if (match) m[match[2].trim()] = match[1].trim(); });
            return m;
        }

        // Navigation
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.drilldown-section').forEach(d => d.classList.remove('active'));
            if (window.innerWidth < 768) toggleSidebar();
        }

        // Data Loading
        async function loadDashboard() {
            try {
                const configData = await fetchSheetData(CONFIG_GID);
                config = {};
                configData.forEach(row => {
                    if (row['Dashboard Name'] === 'P&L Dashboard' && row['GID Number']) {
                        config[row['Tab Name']] = { gid: row['GID Number'], mappings: parseColumnMappings(row['Column Mappings']) };
                    }
                });

                if (config['Orders Data']) {
                    const raw = await fetchSheetData(config['Orders Data'].gid);
                    ordersData = raw.filter(r => (r['Category'] || '').toLowerCase().includes('roll tech') && r['RT Part #']);
                }

                await loadBOMData();
                
                filteredData = [...ordersData];
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${ordersData.length} orders<br>${now.toLocaleTimeString()}`;
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainToolbar').style.display = 'flex';
                document.getElementById('overview').classList.add('active');
                
                initializeDashboard();
                checkAlerts();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">‚ö†Ô∏è Error</h3><p style="color:var(--text-secondary);">${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }

        async function loadBOMData() {
            try {
                if (config['BOM individual items Reference data']) bomIndividualData = await fetchSheetData(config['BOM individual items Reference data'].gid);
                if (config['BOM Sub assembly Reference data']) bomSubData = await fetchSheetData(config['BOM Sub assembly Reference data'].gid);
                if (config['BOM Final assembly Reference data']) bomFinalData = await fetchSheetData(config['BOM Final assembly Reference data'].gid);
            } catch (e) { console.warn('BOM load error:', e); }
        }

        function checkAlerts() {
            const criticalParts = [];
            const stats = {};
            filteredData.forEach(r => {
                const p = r['RT Part #'];
                if (!stats[p]) stats[p] = 0;
                stats[p] += parseNumber(r['P/L']);
            });
            Object.entries(stats).forEach(([part, pl]) => {
                if (pl < -50000) criticalParts.push({ part, pl });
            });
            
            const banner = document.getElementById('alertsBanner');
            const list = document.getElementById('alertsList');
            if (criticalParts.length > 0) {
                criticalParts.sort((a,b) => a.pl - b.pl);
                list.innerHTML = criticalParts.slice(0,5).map(p => `<li><strong>${p.part}</strong>: ${formatCurrency(p.pl)}</li>`).join('');
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
        }

        function initializeDashboard() {
            updateStats();
            updateTopPartsChart();
            updateCustomerPieChart();
            updateMonthlyTrendChart();
            buildPartsTableData();
            renderPartsTable();
            updateAllPartsChart();
            buildCustomersTableData();
            renderCustomersTable();
            updateDateStackedChart();
            updateDatesTable();
            initBomExplorer();
        }

        // Filters
        function applyFilters() {
            const fromVal = document.getElementById('dateFrom').value;
            const toVal = document.getElementById('dateTo').value;
            const from = fromVal ? new Date(fromVal) : null;
            const to = toVal ? new Date(toVal + 'T23:59:59') : null;
            
            filteredData = ordersData.filter(r => {
                const d = parseDate(r['Shipped Date'] || r['Requested Completion Date']);
                if (!d) return true;
                if (from && d < from) return false;
                if (to && d > to) return false;
                return true;
            });
            
            initializeDashboard();
            checkAlerts();
        }

        function clearDateFilter() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            filteredData = [...ordersData];
            initializeDashboard();
            checkAlerts();
        }

        function toggleHeatmap() {
            heatmapEnabled = !heatmapEnabled;
            document.getElementById('heatmapBtn').classList.toggle('active', heatmapEnabled);
            document.body.classList.toggle('heatmap-enabled', heatmapEnabled);
            renderPartsTable();
            renderCustomersTable();
        }

        function toggleFavoritesOnly() {
            favoritesOnly = !favoritesOnly;
            document.getElementById('favoritesBtn').classList.toggle('active', favoritesOnly);
            renderPartsTable();
            renderCustomersTable();
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            document.getElementById('autoRefreshBtn').classList.toggle('active', autoRefreshEnabled);
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(() => loadDashboard(), 300000); // 5 min
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        function toggleFavorite(type, id) {
            const idx = favorites[type].indexOf(id);
            if (idx > -1) favorites[type].splice(idx, 1);
            else favorites[type].push(id);
            localStorage.setItem('rtFavorites', JSON.stringify(favorites));
            if (type === 'parts') renderPartsTable();
            else renderCustomersTable();
        }

        function exportToCSV() {
            const data = partsTableData.map(p => ({
                'Part Number': p.part,
                'Total Qty': p.qty,
                'Avg Profit/Part': p.avgProfit.toFixed(2),
                'Total P/L': p.pl.toFixed(2),
                'Revenue': p.revenue.toFixed(2),
                'Margin %': p.margin.toFixed(2)
            }));
            const headers = Object.keys(data[0]);
            const csv = [headers.join(','), ...data.map(row => headers.map(h => `"${row[h]}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `rolltech_pl_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Notes
        function openNotesModal() {
            if (!selectedPart) return;
            document.getElementById('notesPartName').textContent = selectedPart;
            document.getElementById('notesText').value = notes[selectedPart] || '';
            document.getElementById('notesModal').classList.add('active');
        }
        function closeNotesModal() { document.getElementById('notesModal').classList.remove('active'); }
        function saveNotes() {
            notes[selectedPart] = document.getElementById('notesText').value;
            localStorage.setItem('rtNotes', JSON.stringify(notes));
            closeNotesModal();
            showPartNotes();
        }
        function showPartNotes() {
            const el = document.getElementById('partNotes');
            if (notes[selectedPart]) {
                el.textContent = 'üìù ' + notes[selectedPart];
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        function updateStats() {
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            filteredData.forEach(r => {
                totalRevenue += parseNumber(r['Revenue']);
                const pl = parseNumber(r['P/L']);
                totalPL += pl;
                if ((r['Work order Status'] || '').toLowerCase() === 'shipped') { shippedPL += pl; shippedCount++; }
                else { forecastPL += pl; forecastCount++; }
            });
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('statRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('statOrderCount').textContent = `${filteredData.length} orders`;
            document.getElementById('statPL').innerHTML = formatCurrency(totalPL);
            document.getElementById('statPL').className = 'value ' + (totalPL >= 0 ? 'positive' : 'negative');
            document.getElementById('statMargin').textContent = `Margin: ${margin}%`;
            document.getElementById('statShippedPL').innerHTML = formatCurrency(shippedPL);
            document.getElementById('statShippedPL').className = 'value ' + (shippedPL >= 0 ? 'positive' : 'negative');
            document.getElementById('statShippedCount').textContent = `${shippedCount} shipped`;
            document.getElementById('statForecastPL').innerHTML = formatCurrency(forecastPL);
            document.getElementById('statForecastPL').className = 'value ' + (forecastPL >= 0 ? 'positive' : 'negative');
            document.getElementById('statForecastCount').textContent = `${forecastCount} pending`;
        }

        function updateTopPartsChart() {
            const stats = {};
            filteredData.forEach(r => { const p = r['RT Part #']; if (!stats[p]) stats[p] = 0; stats[p] += parseNumber(r['P/L']); });
            const sorted = Object.entries(stats).sort((a, b) => a[1] - b[1]).slice(0, 10);
            
            const ctx = document.getElementById('topPartsChart');
            if (charts.topParts) charts.topParts.destroy();
            charts.topParts = new Chart(ctx, {
                type: 'bar',
                data: { labels: sorted.map(([p]) => p), datasets: [{ data: sorted.map(([,v]) => v), backgroundColor: sorted.map(([,v]) => v >= 0 ? 'rgba(56,161,105,0.85)' : 'rgba(229,62,62,0.85)'), borderRadius: 6 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.08)' } }, y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } } } }
            });
        }

        function updateAllPartsChart() {
            const sorted = [...partsTableData].sort((a, b) => a.pl - b.pl);
            const ctx = document.getElementById('allPartsChart');
            if (charts.allParts) charts.allParts.destroy();
            charts.allParts = new Chart(ctx, {
                type: 'bar',
                data: { labels: sorted.map(p => p.part), datasets: [{ data: sorted.map(p => p.pl), backgroundColor: sorted.map(p => p.pl >= 0 ? 'rgba(56,161,105,0.85)' : 'rgba(229,62,62,0.85)'), borderRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } } }, scales: { x: { ticks: { color: '#a0aec0', font: { size: 8 }, maxRotation: 90, minRotation: 60 }, grid: { display: false } }, y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.08)' } } }, onClick: (e, el) => { if (el.length > 0) showPartCustomerBreakdown(sorted[el[0].index].part); } }
            });
        }

        function updateCustomerPieChart() {
            const stats = {};
            filteredData.forEach(r => { const c = r['Customer'] || 'Unknown'; if (!stats[c]) stats[c] = 0; stats[c] += Math.abs(parseNumber(r['P/L'])); });
            const sorted = Object.entries(stats).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const ctx = document.getElementById('customerPieChart');
            if (charts.customerPie) charts.customerPie.destroy();
            charts.customerPie = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: sorted.map(([n]) => n.substring(0, 20)), datasets: [{ data: sorted.map(([,v]) => v), backgroundColor: ['#e53e3e','#dd6b20','#d69e2e','#38a169','#319795','#3182ce','#805ad5','#d53f8c'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', padding: 10, font: { size: 10 } } } } }
            });
        }

        function updateMonthlyTrendChart() {
            const stats = {};
            filteredData.forEach(r => {
                const m = parseMonth(r['Requested Completion Date'] || r['Shipped Date']);
                const status = (r['Work order Status'] || '').toLowerCase();
                if (!m) return;
                if (!stats[m]) stats[m] = { shipped: 0, forecast: 0 };
                if (status === 'shipped') stats[m].shipped += parseNumber(r['P/L']);
                else stats[m].forecast += parseNumber(r['P/L']);
            });
            const months = Object.keys(stats).sort();
            const ctx = document.getElementById('monthlyTrendChart');
            if (charts.monthlyTrend) charts.monthlyTrend.destroy();
            charts.monthlyTrend = new Chart(ctx, {
                type: 'line',
                data: { labels: months, datasets: [
                    { label: 'Shipped', data: months.map(m => stats[m].shipped), borderColor: 'rgba(56,161,105,0.9)', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3, pointRadius: 2 },
                    { label: 'Forecasted', data: months.map(m => stats[m].forecast), borderColor: 'rgba(214,158,46,0.9)', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5,5], pointRadius: 2 }
                ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0aec0' } }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.08)' } }, x: { ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } } } }
            });
        }

        // Parts Table
        function buildPartsTableData() {
            const stats = {}, monthlyStats = {};
            filteredData.forEach(r => {
                const p = r['RT Part #'], m = parseMonth(r['Shipped Date'] || r['Requested Completion Date']);
                if (!stats[p]) stats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0, profits: [] };
                stats[p].orders++;
                stats[p].qty += parseNumber(r['Order Qty']);
                stats[p].revenue += parseNumber(r['Revenue']);
                stats[p].pl += parseNumber(r['P/L']);
                const ppp = parseNumber(r['Profit per part']);
                if (ppp !== 0) stats[p].profits.push(ppp);
                if (m) {
                    if (!monthlyStats[p]) monthlyStats[p] = {};
                    if (!monthlyStats[p][m]) monthlyStats[p][m] = 0;
                    monthlyStats[p][m] += parseNumber(r['P/L']);
                }
            });
            partsTableData = Object.entries(stats).map(([part, s]) => {
                const months = monthlyStats[part] ? Object.keys(monthlyStats[part]).sort() : [];
                const recentMonths = months.slice(-3);
                const trend = recentMonths.map(m => monthlyStats[part][m]);
                return {
                    part, qty: s.qty,
                    avgProfit: s.profits.length > 0 ? s.profits.reduce((a,b)=>a+b,0)/s.profits.length : (s.qty > 0 ? s.pl/s.qty : 0),
                    pl: s.pl, revenue: s.revenue,
                    margin: s.revenue ? (s.pl / s.revenue) * 100 : 0,
                    trend
                };
            });
        }

        function sortPartsTable(field) {
            const th = document.querySelector(`#partsTable th[data-sort="${field}"]`);
            document.querySelectorAll('#partsTable th').forEach(h => { h.classList.remove('sorted'); const ind = h.querySelector('.sort-indicator'); if(ind) ind.textContent = '‚ñº'; });
            if (partsSortField === field) partsSortAsc = !partsSortAsc;
            else { partsSortField = field; partsSortAsc = field === 'part'; }
            th.classList.add('sorted');
            th.querySelector('.sort-indicator').textContent = partsSortAsc ? '‚ñ≤' : '‚ñº';
            renderPartsTable();
        }

        function renderPartsTable() {
            let data = [...partsTableData];
            if (favoritesOnly) data = data.filter(p => favorites.parts.includes(p.part));
            data.sort((a, b) => {
                let va = a[partsSortField], vb = b[partsSortField];
                if (typeof va === 'string') return partsSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
                return partsSortAsc ? va - vb : vb - va;
            });
            
            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = data.map(p => {
                const isFav = favorites.parts.includes(p.part);
                const trendArrow = p.trend.length >= 2 ? getTrendArrow(p.trend[p.trend.length-1], p.trend[p.trend.length-2]) : '';
                return `<tr class="clickable" data-part="${p.part}">
                    <td><span class="favorite-star ${isFav?'active':''}" onclick="event.stopPropagation();toggleFavorite('parts','${p.part}')">‚òÖ</span><span class="clickable-cell">${p.part}</span></td>
                    <td>${formatNumber(p.qty)}</td>
                    <td class="${p.avgProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(p.avgProfit)}</td>
                    <td class="${p.pl >= 0 ? 'positive' : 'negative'} heat-cell ${getHeatClass(p.pl)}">${formatCurrency(p.pl)}</td>
                    <td>${formatCurrency(p.revenue)}</td>
                    <td class="${p.margin >= 0 ? 'positive' : 'negative'} heat-cell ${getHeatClass(p.margin,'margin')}">${p.margin.toFixed(2)}%</td>
                    <td>${trendArrow}</td>
                </tr>`;
            }).join('');
            
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => {
                tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected'));
                r.classList.add('selected');
                showPartCustomerBreakdown(r.dataset.part);
            }));
            
            document.getElementById('partsSearch').oninput = e => {
                const f = e.target.value.toLowerCase();
                Array.from(tbody.rows).forEach(r => r.style.display = r.dataset.part.toLowerCase().includes(f) ? '' : 'none');
            };
        }

        function showPartCustomerBreakdown(part) {
            selectedPart = part;
            showPartNotes();
            const partOrders = filteredData.filter(r => r['RT Part #'] === part);
            const customers = {};
            partOrders.forEach(o => {
                const c = o['Customer'] || 'Unknown';
                if (!customers[c]) customers[c] = { qty: 0, revenue: 0, pl: 0, unitPrice: parseNumber(o['Unit Price']), contribution: o['Contribution Level'] };
                customers[c].qty += parseNumber(o['Order Qty']);
                customers[c].revenue += parseNumber(o['Revenue']);
                customers[c].pl += parseNumber(o['P/L']);
            });
            
            const totalQty = partOrders.reduce((s, o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = partOrders.reduce((s, o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = partOrders.reduce((s, o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('selectedPartTitle').textContent = `Part: ${part} | ${Object.keys(customers).length} customers`;
            document.getElementById('partSummary').innerHTML = `
                <div class="summary-item"><div class="label">Customers</div><div class="value">${Object.keys(customers).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            const tbody = document.getElementById('partCustomerTableBody');
            const sorted = Object.entries(customers).sort((a,b) => a[1].pl - b[1].pl);
            tbody.innerHTML = sorted.map(([c, s]) => {
                const margin = s.revenue ? ((s.pl / s.revenue) * 100).toFixed(2) : 0;
                return `<tr class="clickable" data-customer="${c}"><td class="clickable-cell">${c}</td><td>${formatNumber(s.qty)}</td><td>${formatCurrency(s.unitPrice)}</td><td>${getContributionBadge(s.contribution)}</td><td class="${margin >= 0 ? 'positive' : 'negative'}">${margin}%</td><td class="${s.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(s.pl)}</td><td>${formatCurrency(s.revenue)}</td></tr>`;
            }).join('');
            
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => {
                tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected'));
                r.classList.add('selected');
                showPartCustomerOrders(r.dataset.customer);
            }));
            
            document.getElementById('partCustomerBreakdown').classList.add('active');
            document.getElementById('partCustomerOrders').classList.remove('active');
            document.getElementById('partCustomerBreakdown').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showPartCustomerOrders(customer) {
            selectedCustomer = customer;
            const orders = filteredData.filter(r => r['RT Part #'] === selectedPart && r['Customer'] === customer).sort((a,b) => {
                const da = parseDate(a['Shipped Date'] || a['Requested Completion Date']);
                const db = parseDate(b['Shipped Date'] || b['Requested Completion Date']);
                return da - db;
            });
            
            const totalQty = orders.reduce((s, o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = orders.reduce((s, o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = orders.reduce((s, o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('bcPart').textContent = selectedPart;
            document.getElementById('bcCust').textContent = customer;
            document.getElementById('partCustOrdersTitle').textContent = `${orders.length} orders | ${customer}`;
            document.getElementById('partCustOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${orders.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            // Price history chart
            const prices = orders.map(o => ({ date: o['Shipped Date'] || o['Requested Completion Date'], price: parseNumber(o['Unit Price']) })).filter(p => p.price > 0);
            if (prices.length > 1) {
                document.getElementById('priceHistory').innerHTML = `<div style="height:100px;"><canvas id="priceHistoryChart"></canvas></div>`;
                new Chart(document.getElementById('priceHistoryChart'), {
                    type: 'line',
                    data: { labels: prices.map(p => p.date), datasets: [{ label: 'Unit Price', data: prices.map(p => p.price), borderColor: 'rgba(49,130,206,0.9)', backgroundColor: 'rgba(49,130,206,0.1)', fill: true, tension: 0.3, pointRadius: 3 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Price History', color: '#a0aec0', font: { size: 11 } } }, scales: { y: { ticks: { callback: v => '$'+v, color: '#a0aec0', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 8 }, maxRotation: 45 }, grid: { display: false } } } }
                });
            } else {
                document.getElementById('priceHistory').innerHTML = '';
            }
            
            const tbody = document.getElementById('partCustOrdersBody');
            tbody.innerHTML = orders.map((o, i) => {
                const pl = parseNumber(o['P/L']), ppp = parseNumber(o['Profit per part']);
                const prevPrice = i > 0 ? parseNumber(orders[i-1]['Unit Price']) : null;
                const currPrice = parseNumber(o['Unit Price']);
                const priceChange = prevPrice && currPrice !== prevPrice ? (currPrice > prevPrice ? '<span style="color:var(--success);font-size:10px;">‚Üë</span>' : '<span style="color:var(--danger);font-size:10px;">‚Üì</span>') : '';
                return `<tr><td>${o['PO #'] || '-'}</td><td>${getStatusBadge(o['Work order Status'])}</td><td>${formatNumber(parseNumber(o['Order Qty']))}</td><td>${formatCurrency(currPrice)} ${priceChange}</td><td>${getContributionBadge(o['Contribution Level'])}</td><td class="${ppp >= 0 ? 'positive' : 'negative'}">${formatCurrency(ppp)}</td><td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td><td>${formatCurrency(parseNumber(o['Revenue']))}</td><td>${o['Shipped Date'] || o['Requested Completion Date'] || '-'}</td></tr>`;
            }).join('');
            
            document.getElementById('partCustomerOrders').classList.add('active');
            document.getElementById('partCustomerOrders').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function backToPartCustomers() { document.getElementById('partCustomerOrders').classList.remove('active'); selectedCustomer = null; document.querySelectorAll('#partCustomerTableBody tr').forEach(r => r.classList.remove('selected')); }
        function closePartDrilldown() { document.getElementById('partCustomerBreakdown').classList.remove('active'); document.getElementById('partCustomerOrders').classList.remove('active'); selectedPart = null; selectedCustomer = null; document.querySelectorAll('#partsTableBody tr').forEach(r => r.classList.remove('selected')); }
        function closeAllPartDrilldowns() { closePartDrilldown(); }

        // Customers Table
        function buildCustomersTableData() {
            const stats = {}, monthlyStats = {};
            filteredData.forEach(r => {
                const c = r['Customer'] || 'Unknown', m = parseMonth(r['Shipped Date'] || r['Requested Completion Date']);
                if (!stats[c]) stats[c] = { qty: 0, revenue: 0, pl: 0 };
                stats[c].qty += parseNumber(r['Order Qty']);
                stats[c].revenue += parseNumber(r['Revenue']);
                stats[c].pl += parseNumber(r['P/L']);
                if (m) {
                    if (!monthlyStats[c]) monthlyStats[c] = {};
                    if (!monthlyStats[c][m]) monthlyStats[c][m] = 0;
                    monthlyStats[c][m] += parseNumber(r['P/L']);
                }
            });
            customersTableData = Object.entries(stats).map(([customer, s]) => {
                const months = monthlyStats[customer] ? Object.keys(monthlyStats[customer]).sort() : [];
                const trend = months.slice(-3).map(m => monthlyStats[customer][m]);
                return { customer, qty: s.qty, pl: s.pl, revenue: s.revenue, margin: s.revenue ? (s.pl / s.revenue) * 100 : 0, trend };
            });
        }

        function sortCustomersTable(field) {
            const th = document.querySelector(`#customersTable th[data-sort="${field}"]`);
            document.querySelectorAll('#customersTable th').forEach(h => { h.classList.remove('sorted'); const ind = h.querySelector('.sort-indicator'); if(ind) ind.textContent = '‚ñº'; });
            if (customersSortField === field) customersSortAsc = !customersSortAsc;
            else { customersSortField = field; customersSortAsc = field === 'customer'; }
            th.classList.add('sorted');
            th.querySelector('.sort-indicator').textContent = customersSortAsc ? '‚ñ≤' : '‚ñº';
            renderCustomersTable();
        }

        function renderCustomersTable() {
            let data = [...customersTableData];
            if (favoritesOnly) data = data.filter(c => favorites.customers.includes(c.customer));
            data.sort((a, b) => {
                let va = a[customersSortField], vb = b[customersSortField];
                if (typeof va === 'string') return customersSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
                return customersSortAsc ? va - vb : vb - va;
            });
            
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = data.map(c => {
                const isFav = favorites.customers.includes(c.customer);
                const trendArrow = c.trend.length >= 2 ? getTrendArrow(c.trend[c.trend.length-1], c.trend[c.trend.length-2]) : '';
                return `<tr class="clickable" data-customer="${c.customer}">
                    <td><span class="favorite-star ${isFav?'active':''}" onclick="event.stopPropagation();toggleFavorite('customers','${c.customer}')">‚òÖ</span><span class="clickable-cell">${c.customer}</span></td>
                    <td>${formatNumber(c.qty)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'} heat-cell ${getHeatClass(c.pl)}">${formatCurrency(c.pl)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.margin >= 0 ? 'positive' : 'negative'} heat-cell ${getHeatClass(c.margin,'margin')}">${c.margin.toFixed(2)}%</td>
                    <td>${trendArrow}</td>
                </tr>`;
            }).join('');
            
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => {
                tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected'));
                r.classList.add('selected');
                showCustomerProducts(r.dataset.customer);
            }));
            
            document.getElementById('customersSearch').oninput = e => {
                const f = e.target.value.toLowerCase();
                Array.from(tbody.rows).forEach(r => r.style.display = r.dataset.customer.toLowerCase().includes(f) ? '' : 'none');
            };
        }

        function showCustomerProducts(customer) {
            selectedCustomer = customer;
            const orders = filteredData.filter(r => r['Customer'] === customer);
            const parts = {};
            orders.forEach(o => {
                const p = o['RT Part #'];
                if (!parts[p]) parts[p] = { qty: 0, revenue: 0, pl: 0, unitPrice: parseNumber(o['Unit Price']), contribution: o['Contribution Level'] };
                parts[p].qty += parseNumber(o['Order Qty']);
                parts[p].revenue += parseNumber(o['Revenue']);
                parts[p].pl += parseNumber(o['P/L']);
            });
            const totalQty = orders.reduce((s,o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = orders.reduce((s,o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = orders.reduce((s,o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('selectedCustomerTitle').textContent = `Customer: ${customer} | ${Object.keys(parts).length} products`;
            document.getElementById('customerProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Products</div><div class="value">${Object.keys(parts).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL>=0?'positive':'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            const tbody = document.getElementById('customerProductTableBody');
            const sorted = Object.entries(parts).sort((a,b) => a[1].pl - b[1].pl);
            tbody.innerHTML = sorted.map(([p, s]) => {
                const margin = s.revenue ? ((s.pl / s.revenue) * 100).toFixed(2) : 0;
                return `<tr class="clickable" data-part="${p}"><td class="clickable-cell">${p}</td><td>${formatNumber(s.qty)}</td><td>${formatCurrency(s.unitPrice)}</td><td>${getContributionBadge(s.contribution)}</td><td class="${margin>=0?'positive':'negative'}">${margin}%</td><td class="${s.pl>=0?'positive':'negative'}">${formatCurrency(s.pl)}</td><td>${formatCurrency(s.revenue)}</td></tr>`;
            }).join('');
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => { tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected')); r.classList.add('selected'); showPartOrders(r.dataset.part); }));
            
            document.getElementById('customerProductBreakdown').classList.add('active');
            document.getElementById('customerPartOrders').classList.remove('active');
            document.getElementById('customerProductBreakdown').scrollIntoView({ behavior: 'smooth' });
        }

        function showPartOrders(part) {
            selectedPart = part;
            const orders = filteredData.filter(r => r['Customer'] === selectedCustomer && r['RT Part #'] === part);
            const totalQty = orders.reduce((s,o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = orders.reduce((s,o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = orders.reduce((s,o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('bc2Customer').textContent = selectedCustomer;
            document.getElementById('bc2Part').textContent = part;
            document.getElementById('partOrdersTitle').textContent = `${orders.length} orders for ${part}`;
            document.getElementById('partOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${orders.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL>=0?'positive':'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            const tbody = document.getElementById('partOrdersTableBody');
            tbody.innerHTML = orders.map(o => {
                const pl = parseNumber(o['P/L']), ppp = parseNumber(o['Profit per part']);
                return `<tr><td>${o['PO #'] || '-'}</td><td>${getStatusBadge(o['Work order Status'])}</td><td>${formatNumber(parseNumber(o['Order Qty']))}</td><td>${formatCurrency(parseNumber(o['Unit Price']))}</td><td>${getContributionBadge(o['Contribution Level'])}</td><td class="${ppp>=0?'positive':'negative'}">${formatCurrency(ppp)}</td><td class="${pl>=0?'positive':'negative'}">${formatCurrency(pl)}</td><td>${formatCurrency(parseNumber(o['Revenue']))}</td><td>${o['Shipped Date'] || o['Requested Completion Date'] || '-'}</td></tr>`;
            }).join('');
            
            document.getElementById('customerPartOrders').classList.add('active');
            document.getElementById('customerPartOrders').scrollIntoView({ behavior: 'smooth' });
        }

        function closeCustomerDrilldown() { document.getElementById('customerProductBreakdown').classList.remove('active'); document.getElementById('customerPartOrders').classList.remove('active'); selectedCustomer = null; selectedPart = null; document.querySelectorAll('#customersTableBody tr').forEach(r => r.classList.remove('selected')); }
        function backToProducts() { document.getElementById('customerPartOrders').classList.remove('active'); selectedPart = null; document.querySelectorAll('#customerProductTableBody tr').forEach(r => r.classList.remove('selected')); }
        function closeAllCustomerDrilldowns() { closeCustomerDrilldown(); }

        // Date Analysis
        function updateDateStackedChart() {
            const stats = {};
            filteredData.forEach(r => {
                const m = parseMonth(r['Requested Completion Date'] || r['Shipped Date']);
                const status = (r['Work order Status'] || '').toLowerCase();
                const pl = parseNumber(r['P/L']);
                if (!m) return;
                if (!stats[m]) stats[m] = { sp: 0, sl: 0, fp: 0, fl: 0 };
                if (status === 'shipped') { if (pl >= 0) stats[m].sp += pl; else stats[m].sl += pl; }
                else { if (pl >= 0) stats[m].fp += pl; else stats[m].fl += pl; }
            });
            const months = Object.keys(stats).sort();
            const ctx = document.getElementById('dateStackedChart');
            if (charts.dateStacked) charts.dateStacked.destroy();
            charts.dateStacked = new Chart(ctx, {
                type: 'bar',
                data: { labels: months, datasets: [
                    { label: 'Shipped Profit', data: months.map(m => stats[m].sp), backgroundColor: 'rgba(56,161,105,0.9)', stack: 's', borderRadius: 3 },
                    { label: 'Shipped Loss', data: months.map(m => stats[m].sl), backgroundColor: 'rgba(229,62,62,0.9)', stack: 's', borderRadius: 3 },
                    { label: 'Forecast Profit', data: months.map(m => stats[m].fp), backgroundColor: 'rgba(104,211,145,0.7)', stack: 'f', borderRadius: 3 },
                    { label: 'Forecast Loss', data: months.map(m => stats[m].fl), backgroundColor: 'rgba(252,129,129,0.7)', stack: 'f', borderRadius: 3 }
                ] },
                options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => { if (el.length > 0) showMonthBreakdown(months[el[0].index]); }, plugins: { legend: { labels: { color: '#a0aec0', font: { size: 10 } } } }, scales: { x: { stacked: true, ticks: { color: '#a0aec0' }, grid: { display: false } }, y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.08)' } } } }
            });
        }

        function updateDatesTable() {
            const stats = {};
            filteredData.forEach(r => {
                const m = parseMonth(r['Requested Completion Date'] || r['Shipped Date']);
                const status = r['Work order Status'] || 'Unknown';
                if (!m) return;
                const key = `${m}|${status}`;
                if (!stats[key]) stats[key] = { month: m, status, orders: 0, qty: 0, revenue: 0, pl: 0 };
                stats[key].orders++;
                stats[key].qty += parseNumber(r['Order Qty']);
                stats[key].revenue += parseNumber(r['Revenue']);
                stats[key].pl += parseNumber(r['P/L']);
            });
            const sorted = Object.values(stats).sort((a, b) => b.month.localeCompare(a.month));
            const tbody = document.getElementById('datesTableBody');
            tbody.innerHTML = sorted.map(s => `<tr class="clickable" data-month="${s.month}"><td>${s.month}</td><td>${getStatusBadge(s.status)}</td><td>${s.orders}</td><td>${formatNumber(s.qty)}</td><td>${formatCurrency(s.revenue)}</td><td class="${s.pl>=0?'positive':'negative'}">${formatCurrency(s.pl)}</td></tr>`).join('');
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => { tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected')); r.classList.add('selected'); showMonthBreakdown(r.dataset.month); }));
        }

        function showMonthBreakdown(month) {
            selectedMonth = month;
            const orders = filteredData.filter(r => parseMonth(r['Requested Completion Date'] || r['Shipped Date']) === month);
            const customers = {};
            orders.forEach(o => { const c = o['Customer'] || 'Unknown'; if (!customers[c]) customers[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 }; customers[c].orders++; customers[c].qty += parseNumber(o['Order Qty']); customers[c].revenue += parseNumber(o['Revenue']); customers[c].pl += parseNumber(o['P/L']); });
            const totalQty = orders.reduce((s,o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = orders.reduce((s,o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = orders.reduce((s,o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('monthDrilldownTitle').textContent = `Period: ${month} | ${orders.length} orders`;
            document.getElementById('monthDrilldownSummary').innerHTML = `<div class="summary-item"><div class="label">Orders</div><div class="value">${orders.length}</div></div><div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div><div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div><div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL>=0?'positive':'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            const tbody = document.getElementById('monthCustomersTableBody');
            const sorted = Object.entries(customers).sort((a,b) => a[1].pl - b[1].pl);
            tbody.innerHTML = sorted.map(([c, s]) => { const margin = s.revenue ? ((s.pl / s.revenue) * 100).toFixed(2) : 0; return `<tr class="clickable" data-customer="${c}"><td class="clickable-cell">${c}</td><td>${s.orders}</td><td>${formatNumber(s.qty)}</td><td>${formatCurrency(s.revenue)}</td><td class="${s.pl>=0?'positive':'negative'}">${formatCurrency(s.pl)}</td><td class="${margin>=0?'positive':'negative'}">${margin}%</td></tr>`; }).join('');
            tbody.querySelectorAll('tr.clickable').forEach(r => r.addEventListener('click', () => { tbody.querySelectorAll('tr').forEach(x => x.classList.remove('selected')); r.classList.add('selected'); showMonthCustomerOrders(r.dataset.customer); }));
            
            document.getElementById('monthlyDrilldown').classList.add('active');
            document.getElementById('monthCustomerOrders').classList.remove('active');
            document.getElementById('monthlyDrilldown').scrollIntoView({ behavior: 'smooth' });
        }

        function showMonthCustomerOrders(customer) {
            const orders = filteredData.filter(r => parseMonth(r['Requested Completion Date'] || r['Shipped Date']) === selectedMonth && r['Customer'] === customer);
            const totalQty = orders.reduce((s,o) => s + parseNumber(o['Order Qty']), 0);
            const totalRev = orders.reduce((s,o) => s + parseNumber(o['Revenue']), 0);
            const totalPL = orders.reduce((s,o) => s + parseNumber(o['P/L']), 0);
            
            document.getElementById('bcMonth').textContent = selectedMonth;
            document.getElementById('bcCustomer').textContent = customer;
            document.getElementById('monthCustomerTitle').textContent = `${orders.length} orders for ${customer}`;
            document.getElementById('monthCustomerSummary').innerHTML = `<div class="summary-item"><div class="label">Orders</div><div class="value">${orders.length}</div></div><div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div><div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div><div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL>=0?'positive':'negative'}">${formatCurrency(totalPL)}</div></div>`;
            
            const tbody = document.getElementById('monthCustomerOrdersBody');
            tbody.innerHTML = orders.map(o => { const pl = parseNumber(o['P/L']), ppp = parseNumber(o['Profit per part']); return `<tr><td>${o['RT Part #']}</td><td>${o['PO #'] || '-'}</td><td>${getStatusBadge(o['Work order Status'])}</td><td>${formatNumber(parseNumber(o['Order Qty']))}</td><td>${formatCurrency(parseNumber(o['Unit Price']))}</td><td class="${ppp>=0?'positive':'negative'}">${formatCurrency(ppp)}</td><td class="${pl>=0?'positive':'negative'}">${formatCurrency(pl)}</td><td>${formatCurrency(parseNumber(o['Revenue']))}</td></tr>`; }).join('');
            
            document.getElementById('monthCustomerOrders').classList.add('active');
            document.getElementById('monthCustomerOrders').scrollIntoView({ behavior: 'smooth' });
        }

        function closeMonthDrilldown() { document.getElementById('monthlyDrilldown').classList.remove('active'); document.getElementById('monthCustomerOrders').classList.remove('active'); selectedMonth = null; document.querySelectorAll('#datesTableBody tr').forEach(r => r.classList.remove('selected')); }
        function backToMonthCustomers() { document.getElementById('monthCustomerOrders').classList.remove('active'); document.querySelectorAll('#monthCustomersTableBody tr').forEach(r => r.classList.remove('selected')); }
        function closeAllDateDrilldowns() { closeMonthDrilldown(); }

        // BOM Explorer
        function initBomExplorer() { renderBomSelector(); document.getElementById('bomSearch').oninput = e => renderBomSelector(e.target.value.toLowerCase()); }
        function switchBomTab(tab) { currentBomTab = tab; document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab)); renderBomSelector(); document.getElementById('bomPartName').textContent = 'Select a part'; document.getElementById('bomCategory').textContent = ''; document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>'; }
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.map((d, i) => `<div class="bom-item" data-index="${i}" onclick="showBomDetails(${i})">${d[nameKey] || 'Unknown'}</div>`).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index]; if (!part) return;
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', i === index));
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search] of [['Mold','mold'],['Weight','weight'],['Labor/Part','labor cost/ part'],['Overhead','overhead'],['Total Cost','total cost']]) {
                    const key = Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) { const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`); const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`); const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`); if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`; }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search] of [['Parts/Pkg','parts per package'],['Labor','labor cost / finished'],['Variable Cost','variable cost'],['Total Cost','total cost']]) { const key = Object.keys(part).find(k => k.trim().toLowerCase().includes(search)); if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${label !== 'Parts/Pkg' ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`; }
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) { content += `<div class="highlight-box">`; if (profitKey && part[profitKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[profitKey]))}</div><div class="label">Profit Target</div></div>`; if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`; content += `</div>`; }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) { const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`); const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`); const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`); if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`; }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        window.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
