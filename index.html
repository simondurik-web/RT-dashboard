<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roll Tech P&L Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
        }

        /* ===== BASE STYLES ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1421 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== MOBILE HEADER ===== */
        .mobile-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .mobile-header h1 { font-size: 18px; font-weight: 700; }
        .mobile-header .subtitle { font-size: 11px; color: var(--text-secondary); display: block; }
        .menu-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        .sidebar-overlay.active { display: block; }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #a0aec0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo span { font-size: 12px; color: var(--text-secondary); display: block; margin-top: 5px; }
        .nav-section { margin-bottom: 25px; }
        .nav-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 12px; padding-left: 10px; }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.4); }

        /* ===== MAIN CONTENT ===== */
        .main-content { margin-left: 280px; padding: 30px; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== PAGE HEADER ===== */
        .page-header { margin-bottom: 30px; }
        .page-header h2 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .page-header p { color: var(--text-secondary); font-size: 14px; }

        /* ===== STATS GRID ===== */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }

        /* ===== CHARTS ===== */
        .chart-container { background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 30px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .chart-header h3 { font-size: 18px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 350px; }
        .chart-wrapper.large { height: 450px; }

        /* ===== SEARCH BOX ===== */
        .search-box {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            min-width: 200px;
        }
        .search-box:focus { outline: none; border-color: var(--accent); }

        /* ===== TABLES ===== */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: var(--primary);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            cursor: pointer;
            white-space: nowrap;
        }
        .data-table th:hover { background: var(--primary-light); }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .data-table tr:hover { background: rgba(255,255,255,0.05); }
        .data-table tr.clickable { cursor: pointer; }
        .data-table tr.clickable:hover { background: rgba(49,130,206,0.2); }
        .data-table tr.selected { background: rgba(49,130,206,0.3) !important; border-left: 3px solid var(--accent); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .clickable-cell { color: var(--accent); cursor: pointer; text-decoration: underline; }
        .scrollable-table { max-height: 500px; overflow-y: auto; }

        /* ===== BADGES ===== */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge.shipped { background: var(--success); color: white; }
        .badge.forecast { background: var(--warning); color: #1a202c; }
        .badge.target-achieved { background: var(--success); color: white; }
        .badge.net-profitable { background: var(--accent); color: white; }
        .badge.marginal-coverage { background: var(--warning); color: #1a202c; }
        .badge.critical-loss { background: var(--danger); color: white; }

        /* ===== DRILLDOWN SECTIONS ===== */
        .drilldown-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            display: none;
        }
        .drilldown-section.active { display: block; animation: fadeIn 0.3s ease; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; font-weight: 600; }
        .drilldown-header .subtitle { color: var(--accent); font-size: 14px; margin-top: 4px; }
        .close-btn { background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .close-btn:hover { background: #c53030; }
        .back-btn { background: var(--bg-dark); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-right: 10px; transition: all 0.2s; }
        .back-btn:hover { background: var(--primary-light); }

        /* ===== SUMMARY ROW ===== */
        .summary-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 15px 20px; border-radius: 10px; min-width: 130px; }
        .summary-item .label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; }
        .summary-item .value { font-size: 20px; font-weight: 700; }

        /* ===== BREADCRUMB ===== */
        .breadcrumb { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 14px; color: var(--text-secondary); flex-wrap: wrap; }
        .breadcrumb span { color: var(--accent); font-weight: 600; }
        .breadcrumb .separator { color: var(--text-secondary); }

        /* ===== TABS ===== */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: var(--accent); border-color: var(--accent); }

        /* ===== BOM EXPLORER ===== */
        .bom-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .bom-selector { max-height: 500px; overflow-y: auto; padding: 15px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; margin-bottom: 8px; }
        .bom-item:hover { border-color: var(--accent); background: var(--primary-light); }
        .bom-item.selected { border-color: var(--accent); background: var(--accent); }
        .bom-details { background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; }
        .bom-header h3 { font-size: 24px; margin-bottom: 8px; }
        .bom-header .category { color: var(--accent); font-size: 14px; }
        .bom-section { margin-bottom: 25px; }
        .bom-section h4 { font-size: 14px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 0.5px; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 10px; }
        .component-item .name { font-weight: 500; }
        .component-item .details { display: flex; gap: 20px; color: var(--text-secondary); font-size: 13px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 13px; }
        .cost-item .label { color: var(--text-secondary); }
        .highlight-box {
            background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .highlight-box .item { flex: 1; min-width: 100px; }
        .highlight-box .value { font-size: 24px; font-weight: 700; }
        .highlight-box .label { font-size: 12px; opacity: 0.8; }

        /* ===== LOADING & ERROR STATES ===== */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-state { display: none; text-align: center; padding: 60px 20px; }
        .error-state h3 { color: var(--danger); margin-bottom: 10px; }

        /* ===== GRID LAYOUTS ===== */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
        @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }

        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { left: -100%; }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0; padding: 15px; }
            .page-header h2 { font-size: 24px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 16px; }
            .stat-card .value { font-size: 22px; }
            .chart-wrapper { height: 280px; }
            .scrollable-table { overflow-x: auto; }
            .data-table { min-width: 600px; }
            .bom-grid { grid-template-columns: 1fr; }
            .summary-row { gap: 10px; }
            .summary-item { min-width: 100px; padding: 12px 15px; }
            .summary-item .value { font-size: 16px; }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div>
            <h1>Roll Tech</h1>
            <span class="subtitle">P&L Analytics Dashboard</span>
        </div>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>Roll Tech</h1>
            <span>P&L Analytics Dashboard</span>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Dashboards</div>
            <div class="nav-item active" data-page="overview" onclick="navigateTo('overview')">üìä Overview</div>
            <div class="nav-item" data-page="parts" onclick="navigateTo('parts')">üîß Parts Analysis</div>
            <div class="nav-item" data-page="customers" onclick="navigateTo('customers')">üë• Customer Analysis</div>
            <div class="nav-item" data-page="dates" onclick="navigateTo('dates')">üìÖ Date Analysis</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Tools</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')">üìã BOM Explorer</div>
        </div>
        <div class="nav-section" style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:11px; color:var(--text-secondary); padding:10px;">
                <div id="dataInfo">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="margin-top:20px; color:var(--text-secondary);">Loading data from Google Sheets...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state">
            <h3>‚ö†Ô∏è Error Loading Data</h3>
            <p id="errorMessage" style="color:var(--text-secondary);"></p>
            <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer;">Retry</button>
        </div>

        <!-- Overview Page -->
        <div id="overview" class="page">
            <div class="page-header">
                <h2>Dashboard Overview</h2>
                <p>Summary of P&L performance across all Roll Tech orders</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Total Revenue</div>
                    <div class="value" id="statRevenue">$0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total P/L</div>
                    <div class="value" id="statPL">$0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Quantity</div>
                    <div class="value" id="statQuantity">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Orders</div>
                    <div class="value" id="statOrders">0</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Top 10 Parts by P/L</h3></div>
                <div class="chart-wrapper"><canvas id="topPartsChart"></canvas></div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3>Customer Distribution</h3></div>
                    <div class="chart-wrapper"><canvas id="customerPieChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3>Monthly Trend</h3></div>
                    <div class="chart-wrapper"><canvas id="monthlyTrendChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Parts Analysis Page -->
        <div id="parts" class="page">
            <div class="page-header">
                <h2>Parts Analysis</h2>
                <p>Detailed P&L breakdown by part number</p>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>All Parts P/L</h3>
                    <input type="text" class="search-box" id="partsSearch" placeholder="Search parts...">
                </div>
                <div class="scrollable-table">
                    <table class="data-table" id="partsTable">
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Orders</th>
                                <th>Quantity</th>
                                <th>Revenue</th>
                                <th>P/L</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="partsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Analysis Page -->
        <div id="customers" class="page">
            <div class="page-header">
                <h2>Customer Analysis</h2>
                <p>P&L breakdown by customer</p>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Customer P/L Breakdown</h3>
                </div>
                <div class="chart-wrapper large"><canvas id="customerBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>All Customers</h3>
                    <input type="text" class="search-box" id="customersSearch" placeholder="Search customers...">
                </div>
                <div class="scrollable-table">
                    <table class="data-table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Orders</th>
                                <th>Quantity</th>
                                <th>Revenue</th>
                                <th>P/L</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Customer Product Drilldown -->
            <div id="customerProductBreakdown" class="drilldown-section">
                <div class="drilldown-header">
                    <div>
                        <h3 id="selectedCustomerTitle">Customer Details</h3>
                    </div>
                    <button class="close-btn" onclick="closeCustomerProductDrilldown()">‚úï Close</button>
                </div>
                <div class="summary-row" id="customerProductSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Part</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Status</th>
                                <th>Revenue</th>
                                <th>P/L</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="customerProductTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Date Analysis Page -->
        <div id="dates" class="page">
            <div class="page-header">
                <h2>Date Analysis</h2>
                <p>Click on a month to see customer breakdown</p>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly P/L (Shipped vs Forecast)</h3></div>
                <div class="chart-wrapper large"><canvas id="dateStackedChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly Breakdown</h3></div>
                <div class="scrollable-table">
                    <table class="data-table" id="dateTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Status</th>
                                <th>Orders</th>
                                <th>Quantity</th>
                                <th>Revenue</th>
                                <th>P/L</th>
                            </tr>
                        </thead>
                        <tbody id="datesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Customer Drilldown -->
            <div id="monthlyCustomerBreakdown" class="drilldown-section">
                <div class="drilldown-header">
                    <div>
                        <h3 id="selectedMonthTitle">Monthly Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeMonthlyDrilldown()">‚úï Close</button>
                </div>
                <div class="summary-row" id="monthSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table" id="monthlyCustomerTable">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Orders</th>
                                <th>Quantity</th>
                                <th>Revenue</th>
                                <th>P/L</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyCustomerTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Customer Order Details Drilldown -->
            <div id="customerOrderDetails" class="drilldown-section">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">
                            Period: <span id="breadcrumbMonth"></span>
                            <span class="separator">‚Ä∫</span>
                            Customer: <span id="breadcrumbCustomer"></span>
                        </div>
                        <h3 id="orderDetailsTitle">Order Details</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToMonthlyBreakdown()">‚Üê Back</button>
                        <button class="close-btn" onclick="closeCustomerOrderDrilldown()">‚úï Close</button>
                    </div>
                </div>
                <div class="summary-row" id="customerOrderSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Part</th>
                                <th>PO #</th>
                                <th>Status</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Profit/Part</th>
                                <th>P/L</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="customerOrderTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOM Explorer Page -->
        <div id="bom" class="page">
            <div class="page-header">
                <h2>BOM Explorer</h2>
                <p>Browse Bill of Materials for assemblies and parts</p>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" placeholder="Search parts...">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector">
                        <p style="color:var(--text-secondary);">Loading BOM data...</p>
                    </div>
                    <div class="bom-details" id="bomDetails">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent">
                            <p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const CONFIG_GID = '912029812';
        
        // ===== GLOBAL STATE =====
        let config = {};
        let ordersData = [];
        let bomFinalData = [];
        let bomSubData = [];
        let bomIndividualData = [];
        let charts = {};
        let selectedMonth = null;
        let selectedCustomer = null;
        let currentBomTab = 'final';

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        function formatNumber(value) {
            if (value === null || value === undefined || isNaN(value)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.round(value));
        }

        function parseNumber(value) {
            if (!value || value === '') return 0;
            if (typeof value === 'number') return value;
            // Remove $, commas, spaces, and handle parentheses for negatives
            let cleaned = String(value).replace(/[$,\s]/g, '');
            // Handle accounting format (123) = -123
            if (cleaned.startsWith('(') && cleaned.endsWith(')')) {
                cleaned = '-' + cleaned.slice(1, -1);
            }
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function getContributionBadge(level) {
            if (!level) return '<span class="badge">Unknown</span>';
            const l = level.toLowerCase();
            if (l.includes('target achieved')) return '<span class="badge target-achieved">Target Achieved</span>';
            if (l.includes('net profitable')) return '<span class="badge net-profitable">Net Profitable</span>';
            if (l.includes('marginal')) return '<span class="badge marginal-coverage">Marginal Coverage</span>';
            if (l.includes('critical')) return '<span class="badge critical-loss">Critical Loss</span>';
            return `<span class="badge">${level}</span>`;
        }

        // ===== CSV PARSING =====
        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            
            // Parse header row
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        async function fetchSheetData(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to fetch data from GID ${gid}`);
            const text = await response.text();
            return parseCSV(text);
        }

        function parseColumnMappings(mappingText) {
            if (!mappingText) return {};
            // Split by semicolon OR newline
            const lines = mappingText.split(/[;\n]/);
            const mappings = {};
            lines.forEach(line => {
                const match = line.match(/(.+?)\s*‚Üí\s*(.+)/);
                if (match) {
                    mappings[match[2].trim()] = match[1].trim();
                }
            });
            return mappings;
        }

        function applyMapping(row, mapping) {
            const mapped = {};
            for (const [fieldName, columnName] of Object.entries(mapping)) {
                mapped[fieldName] = row[columnName] || '';
            }
            // Also preserve the original Category column for filtering
            if (row['Category']) mapped.category = row['Category'];
            return mapped;
        }

        // ===== NAVIGATION =====
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function navigateTo(pageName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) item.classList.add('active');
            });
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            
            // Close any open drilldowns
            document.querySelectorAll('.drilldown-section').forEach(d => d.classList.remove('active'));
            
            if (window.innerWidth < 768) toggleSidebar();
        }

        // ===== DATA LOADING =====
        async function loadDashboard() {
            try {
                console.log('Loading Dashboard Config...');
                const configData = await fetchSheetData(CONFIG_GID);
                console.log('Config data rows:', configData.length);

                // Parse config
                config = {};
                configData.forEach(row => {
                    if (row['Dashboard Name'] === 'P&L Dashboard' && row['GID Number']) {
                        const tabName = row['Tab Name'];
                        const gid = row['GID Number'];
                        const mappings = parseColumnMappings(row['Column Mappings']);
                        config[tabName] = { gid, mappings };
                        console.log(`Config for ${tabName}:`, { gid, mappingCount: Object.keys(mappings).length });
                    }
                });

                // Load Orders Data
                if (config['Orders Data']) {
                    console.log('Loading Orders Data from GID:', config['Orders Data'].gid);
                    const rawData = await fetchSheetData(config['Orders Data'].gid);
                    console.log('Raw data rows:', rawData.length);
                    
                    // Apply mapping AND filter for Roll tech only
                    ordersData = rawData
                        .map(row => applyMapping(row, config['Orders Data'].mappings))
                        .filter(row => {
                            const category = row.category || '';
                            return category.toLowerCase().includes('roll tech');
                        })
                        .filter(row => row.partNumber); // Also filter out rows without part numbers
                    
                    console.log('Filtered Roll Tech orders:', ordersData.length);
                    
                    // Debug: Log first row to verify mapping
                    if (ordersData.length > 0) {
                        console.log('Sample row:', ordersData[0]);
                    }
                }

                // Load BOM Data
                await loadBOMData();

                // Update data info
                document.getElementById('dataInfo').innerHTML = `
                    <strong>Data Loaded</strong><br>
                    ${ordersData.length} Roll Tech orders<br>
                    Last refreshed: ${new Date().toLocaleTimeString()}
                `;

                // Hide loading, show dashboard
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('overview').classList.add('active');

                // Initialize dashboard
                initializeDashboard();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        async function loadBOMData() {
            try {
                // Load Individual Items
                if (config['BOM individual items Reference data']) {
                    const rawBOM = await fetchSheetData(config['BOM individual items Reference data'].gid);
                    bomIndividualData = rawBOM.map(row => applyMapping(row, config['BOM individual items Reference data'].mappings));
                    console.log('Loaded', bomIndividualData.length, 'individual BOM items');
                }
                
                // Load Sub Assembly
                if (config['BOM Sub assembly Reference data']) {
                    const rawBOM = await fetchSheetData(config['BOM Sub assembly Reference data'].gid);
                    bomSubData = rawBOM.map(row => applyMapping(row, config['BOM Sub assembly Reference data'].mappings));
                    console.log('Loaded', bomSubData.length, 'sub assembly items');
                }
                
                // Load Final Assembly
                if (config['BOM Final assembly Reference data']) {
                    const rawBOM = await fetchSheetData(config['BOM Final assembly Reference data'].gid);
                    bomFinalData = rawBOM.map(row => applyMapping(row, config['BOM Final assembly Reference data'].mappings));
                    console.log('Loaded', bomFinalData.length, 'final assembly items');
                }
            } catch (e) {
                console.warn('BOM data load error:', e);
            }
        }

        // ===== DASHBOARD INITIALIZATION =====
        function initializeDashboard() {
            updateStats();
            updateTopPartsChart();
            updateCustomerPieChart();
            updateMonthlyTrendChart();
            updatePartsTable();
            updateCustomersTable();
            updateCustomerBarChart();
            updateDateStackedChart();
            updateDatesTable();
            initBomExplorer();
        }

        function updateStats() {
            const totalRevenue = ordersData.reduce((sum, row) => sum + parseNumber(row.revenue), 0);
            const totalPL = ordersData.reduce((sum, row) => sum + parseNumber(row.profitLoss), 0);
            const totalQty = ordersData.reduce((sum, row) => sum + parseNumber(row.quantity), 0);
            const totalOrders = ordersData.length;

            document.getElementById('statRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('statPL').textContent = formatCurrency(totalPL);
            document.getElementById('statPL').className = 'value ' + (totalPL >= 0 ? 'positive' : 'negative');
            document.getElementById('statQuantity').textContent = formatNumber(totalQty);
            document.getElementById('statOrders').textContent = formatNumber(totalOrders);
        }

        function updateTopPartsChart() {
            const partStats = {};
            ordersData.forEach(row => {
                const part = row.partNumber;
                if (!part) return;
                if (!partStats[part]) partStats[part] = { revenue: 0, pl: 0, qty: 0, orders: 0 };
                partStats[part].revenue += parseNumber(row.revenue);
                partStats[part].pl += parseNumber(row.profitLoss);
                partStats[part].qty += parseNumber(row.quantity);
                partStats[part].orders++;
            });

            const sorted = Object.entries(partStats)
                .sort((a, b) => b[1].pl - a[1].pl)
                .slice(0, 10);

            const ctx = document.getElementById('topPartsChart');
            if (charts.topParts) charts.topParts.destroy();
            
            charts.topParts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([part]) => part),
                    datasets: [{
                        label: 'P/L',
                        data: sorted.map(([, stats]) => stats.pl),
                        backgroundColor: sorted.map(([, stats]) => stats.pl >= 0 ? '#38a169' : '#e53e3e'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.raw) } }
                    },
                    scales: {
                        y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: '#4a5568' } },
                        x: { ticks: { color: '#a0aec0', maxRotation: 45 }, grid: { display: false } }
                    }
                }
            });
        }

        function updateCustomerPieChart() {
            const customerStats = {};
            ordersData.forEach(row => {
                const customer = row.customer || 'Unknown';
                if (!customerStats[customer]) customerStats[customer] = { revenue: 0, pl: 0 };
                customerStats[customer].revenue += parseNumber(row.revenue);
                customerStats[customer].pl += parseNumber(row.profitLoss);
            });

            const sorted = Object.entries(customerStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            const ctx = document.getElementById('customerPieChart');
            if (charts.customerPie) charts.customerPie.destroy();

            charts.customerPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(([name]) => name.substring(0, 20)),
                    datasets: [{
                        data: sorted.map(([, stats]) => stats.revenue),
                        backgroundColor: ['#3182ce', '#38a169', '#e53e3e', '#d69e2e', '#805ad5', '#319795', '#dd6b20', '#9f7aea', '#48bb78', '#f687b3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#a0aec0', font: { size: 11 } } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
                    }
                }
            });
        }

        function updateMonthlyTrendChart() {
            const monthStats = {};
            ordersData.forEach(row => {
                const date = row.date || row.shippedDate;
                if (!date) return;
                
                // Handle different date formats
                let month;
                if (date.includes('/')) {
                    // M/D/YYYY format
                    const parts = date.split('/');
                    if (parts.length >= 3) {
                        const m = parts[0].padStart(2, '0');
                        const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        month = `${y}-${m}`;
                    }
                } else if (date.includes('-')) {
                    // YYYY-MM-DD format
                    month = date.substring(0, 7);
                } else {
                    return;
                }
                
                if (!month || month.length < 7) return;
                
                if (!monthStats[month]) monthStats[month] = { revenue: 0, pl: 0 };
                monthStats[month].revenue += parseNumber(row.revenue);
                monthStats[month].pl += parseNumber(row.profitLoss);
            });

            const sorted = Object.entries(monthStats).sort((a, b) => a[0].localeCompare(b[0]));

            const ctx = document.getElementById('monthlyTrendChart');
            if (charts.monthlyTrend) charts.monthlyTrend.destroy();

            charts.monthlyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(([month]) => month),
                    datasets: [
                        {
                            label: 'Revenue',
                            data: sorted.map(([, stats]) => stats.revenue),
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'P/L',
                            data: sorted.map(([, stats]) => stats.pl),
                            borderColor: '#38a169',
                            backgroundColor: 'rgba(56,161,105,0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#a0aec0' } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } }
                    },
                    scales: {
                        y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: '#4a5568' } },
                        x: { ticks: { color: '#a0aec0' }, grid: { display: false } }
                    }
                }
            });
        }

        function updateCustomerBarChart() {
            const customerStats = {};
            ordersData.forEach(row => {
                const customer = row.customer || 'Unknown';
                if (!customerStats[customer]) customerStats[customer] = { revenue: 0, pl: 0, qty: 0, orders: 0 };
                customerStats[customer].revenue += parseNumber(row.revenue);
                customerStats[customer].pl += parseNumber(row.profitLoss);
                customerStats[customer].qty += parseNumber(row.quantity);
                customerStats[customer].orders++;
            });

            const sorted = Object.entries(customerStats).sort((a, b) => a[1].pl - b[1].pl);

            const ctx = document.getElementById('customerBarChart');
            if (charts.customerBar) charts.customerBar.destroy();

            charts.customerBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name.substring(0, 25)),
                    datasets: [{
                        data: sorted.map(([, stats]) => stats.pl),
                        backgroundColor: sorted.map(([, stats]) => stats.pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } }
                    },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: '#4a5568' } },
                        y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }

        function updateDateStackedChart() {
            const monthlyData = {};
            ordersData.forEach(row => {
                const date = row.date || row.shippedDate;
                const status = row.status || 'Unknown';
                if (!date) return;
                
                let month;
                if (date.includes('/')) {
                    const parts = date.split('/');
                    if (parts.length >= 3) {
                        const m = parts[0].padStart(2, '0');
                        const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        month = `${y}-${m}`;
                    }
                } else if (date.includes('-')) {
                    month = date.substring(0, 7);
                }
                
                if (!month || month.length < 7) return;
                
                if (!monthlyData[month]) monthlyData[month] = { shippedProfit: 0, shippedLoss: 0, forecastProfit: 0, forecastLoss: 0 };
                
                const pl = parseNumber(row.profitLoss);
                const isShipped = status.toLowerCase() === 'shipped';
                
                if (isShipped) {
                    if (pl >= 0) monthlyData[month].shippedProfit += pl;
                    else monthlyData[month].shippedLoss += pl;
                } else {
                    if (pl >= 0) monthlyData[month].forecastProfit += pl;
                    else monthlyData[month].forecastLoss += pl;
                }
            });

            const months = Object.keys(monthlyData).sort();

            const ctx = document.getElementById('dateStackedChart');
            if (charts.dateStacked) charts.dateStacked.destroy();

            charts.dateStacked = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Shipped Profit', data: months.map(m => monthlyData[m].shippedProfit), backgroundColor: 'rgba(56,161,105,0.9)', borderRadius: 4, stack: 'shipped' },
                        { label: 'Shipped Loss', data: months.map(m => monthlyData[m].shippedLoss), backgroundColor: 'rgba(229,62,62,0.9)', borderRadius: 4, stack: 'shipped' },
                        { label: 'Forecast Profit', data: months.map(m => monthlyData[m].forecastProfit), backgroundColor: 'rgba(104,211,145,0.7)', borderRadius: 4, stack: 'forecast' },
                        { label: 'Forecast Loss', data: months.map(m => monthlyData[m].forecastLoss), backgroundColor: 'rgba(252,129,129,0.7)', borderRadius: 4, stack: 'forecast' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            showMonthlyBreakdown(months[index]);
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#a0aec0' } },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: '#a0aec0' }, grid: { display: false } },
                        y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: '#4a5568' } }
                    }
                }
            });
        }

        function updatePartsTable() {
            const partStats = {};
            ordersData.forEach(row => {
                const part = row.partNumber;
                if (!part) return;
                if (!partStats[part]) partStats[part] = { revenue: 0, pl: 0, qty: 0, orders: 0 };
                partStats[part].revenue += parseNumber(row.revenue);
                partStats[part].pl += parseNumber(row.profitLoss);
                partStats[part].qty += parseNumber(row.quantity);
                partStats[part].orders++;
            });

            const sorted = Object.entries(partStats).sort((a, b) => b[1].pl - a[1].pl);
            const tbody = document.getElementById('partsTableBody');
            
            tbody.innerHTML = sorted.map(([part, stats]) => {
                const margin = stats.revenue ? ((stats.pl / stats.revenue) * 100).toFixed(1) : 0;
                return `<tr class="clickable" data-part="${part}">
                    <td>${part}</td>
                    <td>${stats.orders}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin}%</td>
                </tr>`;
            }).join('');

            // Search functionality
            document.getElementById('partsSearch').oninput = (e) => {
                const filter = e.target.value.toLowerCase();
                Array.from(tbody.rows).forEach(row => {
                    const text = row.cells[0].textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            };
        }

        function updateCustomersTable() {
            const customerStats = {};
            ordersData.forEach(row => {
                const customer = row.customer || 'Unknown';
                if (!customerStats[customer]) customerStats[customer] = { revenue: 0, pl: 0, qty: 0, orders: 0 };
                customerStats[customer].revenue += parseNumber(row.revenue);
                customerStats[customer].pl += parseNumber(row.profitLoss);
                customerStats[customer].qty += parseNumber(row.quantity);
                customerStats[customer].orders++;
            });

            const sorted = Object.entries(customerStats).sort((a, b) => b[1].pl - a[1].pl);
            const tbody = document.getElementById('customersTableBody');
            
            tbody.innerHTML = sorted.map(([customer, stats]) => {
                const margin = stats.revenue ? ((stats.pl / stats.revenue) * 100).toFixed(1) : 0;
                return `<tr class="clickable" data-customer="${customer}">
                    <td class="clickable-cell">${customer}</td>
                    <td>${stats.orders}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin}%</td>
                </tr>`;
            }).join('');

            // Click handler for customer drilldown
            tbody.querySelectorAll('tr.clickable').forEach(row => {
                row.addEventListener('click', () => {
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    showCustomerProductBreakdown(row.dataset.customer);
                });
            });

            // Search functionality
            document.getElementById('customersSearch').oninput = (e) => {
                const filter = e.target.value.toLowerCase();
                Array.from(tbody.rows).forEach(row => {
                    const text = row.cells[0].textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            };
        }

        function showCustomerProductBreakdown(customer) {
            const customerOrders = ordersData.filter(row => row.customer === customer);
            
            const totalQty = customerOrders.reduce((sum, o) => sum + parseNumber(o.quantity), 0);
            const totalRevenue = customerOrders.reduce((sum, o) => sum + parseNumber(o.revenue), 0);
            const totalPL = customerOrders.reduce((sum, o) => sum + parseNumber(o.profitLoss), 0);
            
            document.getElementById('selectedCustomerTitle').textContent = `Customer: ${customer} | ${customerOrders.length} orders`;
            document.getElementById('customerProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${customerOrders.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRevenue)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const tbody = document.getElementById('customerProductTableBody');
            tbody.innerHTML = customerOrders.map(o => {
                const pl = parseNumber(o.profitLoss);
                const revenue = parseNumber(o.revenue);
                const margin = revenue ? ((pl / revenue) * 100).toFixed(1) : 0;
                return `<tr>
                    <td>${o.partNumber}</td>
                    <td>${formatNumber(parseNumber(o.quantity))}</td>
                    <td>${formatCurrency(parseNumber(o.unitPrice))}</td>
                    <td><span class="badge ${(o.status || '').toLowerCase() === 'shipped' ? 'shipped' : 'forecast'}">${o.status || 'Unknown'}</span></td>
                    <td>${formatCurrency(revenue)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin}%</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customerProductBreakdown').classList.add('active');
            document.getElementById('customerProductBreakdown').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeCustomerProductDrilldown() {
            document.getElementById('customerProductBreakdown').classList.remove('active');
            document.querySelectorAll('#customersTableBody tr').forEach(r => r.classList.remove('selected'));
        }

        function updateDatesTable() {
            const monthStats = {};
            ordersData.forEach(row => {
                const date = row.date || row.shippedDate;
                const status = row.status || 'Unknown';
                if (!date) return;
                
                let month;
                if (date.includes('/')) {
                    const parts = date.split('/');
                    if (parts.length >= 3) {
                        const m = parts[0].padStart(2, '0');
                        const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        month = `${y}-${m}`;
                    }
                } else if (date.includes('-')) {
                    month = date.substring(0, 7);
                }
                
                if (!month || month.length < 7) return;
                
                const key = `${month}|${status}`;
                if (!monthStats[key]) monthStats[key] = { month, status, revenue: 0, pl: 0, qty: 0, orders: 0 };
                monthStats[key].revenue += parseNumber(row.revenue);
                monthStats[key].pl += parseNumber(row.profitLoss);
                monthStats[key].qty += parseNumber(row.quantity);
                monthStats[key].orders++;
            });

            const sorted = Object.values(monthStats).sort((a, b) => b.month.localeCompare(a.month));
            const tbody = document.getElementById('datesTableBody');
            
            tbody.innerHTML = sorted.map(stats => {
                const badgeClass = stats.status.toLowerCase() === 'shipped' ? 'shipped' : 'forecast';
                return `<tr class="clickable" data-month="${stats.month}">
                    <td>${stats.month}</td>
                    <td><span class="badge ${badgeClass}">${stats.status}</span></td>
                    <td>${stats.orders}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                </tr>`;
            }).join('');

            tbody.querySelectorAll('tr.clickable').forEach(row => {
                row.addEventListener('click', () => {
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    showMonthlyBreakdown(row.dataset.month);
                });
            });
        }

        // ===== DATE DRILLDOWN FUNCTIONS =====
        function showMonthlyBreakdown(month) {
            selectedMonth = month;
            selectedCustomer = null;
            
            // Get orders for this month
            const monthOrders = ordersData.filter(row => {
                const date = row.date || row.shippedDate;
                if (!date) return false;
                let m;
                if (date.includes('/')) {
                    const parts = date.split('/');
                    if (parts.length >= 3) {
                        const mm = parts[0].padStart(2, '0');
                        const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        m = `${y}-${mm}`;
                    }
                } else if (date.includes('-')) {
                    m = date.substring(0, 7);
                }
                return m === month;
            });
            
            // Aggregate by customer
            const customerData = {};
            monthOrders.forEach(o => {
                const customer = o.customer || 'Unknown';
                if (!customerData[customer]) customerData[customer] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                customerData[customer].orders++;
                customerData[customer].qty += parseNumber(o.quantity);
                customerData[customer].revenue += parseNumber(o.revenue);
                customerData[customer].pl += parseNumber(o.profitLoss);
            });
            
            const totalOrders = monthOrders.length;
            const totalQty = monthOrders.reduce((sum, o) => sum + parseNumber(o.quantity), 0);
            const totalRevenue = monthOrders.reduce((sum, o) => sum + parseNumber(o.revenue), 0);
            const totalPL = monthOrders.reduce((sum, o) => sum + parseNumber(o.profitLoss), 0);
            
            document.getElementById('selectedMonthTitle').textContent = `Period: ${month} | ${totalOrders} orders`;
            document.getElementById('monthSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${totalOrders}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRevenue)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const customerArray = Object.entries(customerData).map(([name, data]) => ({ name, ...data })).sort((a, b) => a.pl - b.pl);
            const tbody = document.getElementById('monthlyCustomerTableBody');
            tbody.innerHTML = customerArray.map(c => {
                const margin = c.revenue ? ((c.pl / c.revenue) * 100).toFixed(2) : 0;
                return `<tr class="clickable" data-customer="${c.name}">
                    <td class="clickable-cell">${c.name}</td>
                    <td>${c.orders}</td>
                    <td>${formatNumber(c.qty)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(c.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin}%</td>
                </tr>`;
            }).join('');
            
            tbody.querySelectorAll('tr.clickable').forEach(row => {
                row.addEventListener('click', () => {
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    showCustomerOrderDetails(row.dataset.customer);
                });
            });
            
            document.getElementById('monthlyCustomerBreakdown').classList.add('active');
            document.getElementById('customerOrderDetails').classList.remove('active');
            document.getElementById('monthlyCustomerBreakdown').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCustomerOrderDetails(customer) {
            selectedCustomer = customer;
            
            // Get orders for this month and customer
            const orders = ordersData.filter(row => {
                const date = row.date || row.shippedDate;
                if (!date) return false;
                let m;
                if (date.includes('/')) {
                    const parts = date.split('/');
                    if (parts.length >= 3) {
                        const mm = parts[0].padStart(2, '0');
                        const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        m = `${y}-${mm}`;
                    }
                } else if (date.includes('-')) {
                    m = date.substring(0, 7);
                }
                return m === selectedMonth && row.customer === customer;
            });
            
            const totalQty = orders.reduce((sum, o) => sum + parseNumber(o.quantity), 0);
            const totalRevenue = orders.reduce((sum, o) => sum + parseNumber(o.revenue), 0);
            const totalPL = orders.reduce((sum, o) => sum + parseNumber(o.profitLoss), 0);
            
            document.getElementById('breadcrumbMonth').textContent = selectedMonth;
            document.getElementById('breadcrumbCustomer').textContent = customer;
            document.getElementById('orderDetailsTitle').textContent = `${orders.length} orders for ${customer}`;
            document.getElementById('customerOrderSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${orders.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRevenue)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const tbody = document.getElementById('customerOrderTableBody');
            tbody.innerHTML = orders.map(o => {
                const pl = parseNumber(o.profitLoss);
                const profitPerPart = parseNumber(o.profitPerPart);
                return `<tr>
                    <td>${o.partNumber}</td>
                    <td>${o.poNumber || ''}</td>
                    <td><span class="badge ${(o.status || '').toLowerCase() === 'shipped' ? 'shipped' : 'forecast'}">${o.status || 'Unknown'}</span></td>
                    <td>${formatNumber(parseNumber(o.quantity))}</td>
                    <td>${formatCurrency(parseNumber(o.unitPrice))}</td>
                    <td class="${profitPerPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPerPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(parseNumber(o.revenue))}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customerOrderDetails').classList.add('active');
            document.getElementById('customerOrderDetails').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeMonthlyDrilldown() {
            document.getElementById('monthlyCustomerBreakdown').classList.remove('active');
            document.getElementById('customerOrderDetails').classList.remove('active');
            selectedMonth = null;
            selectedCustomer = null;
            document.querySelectorAll('#datesTableBody tr').forEach(r => r.classList.remove('selected'));
        }

        function closeCustomerOrderDrilldown() {
            document.getElementById('customerOrderDetails').classList.remove('active');
            selectedCustomer = null;
            document.querySelectorAll('#monthlyCustomerTableBody tr').forEach(r => r.classList.remove('selected'));
        }

        function backToMonthlyBreakdown() {
            document.getElementById('customerOrderDetails').classList.remove('active');
            selectedCustomer = null;
            document.querySelectorAll('#monthlyCustomerTableBody tr').forEach(r => r.classList.remove('selected'));
            document.getElementById('monthlyCustomerBreakdown').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ===== BOM EXPLORER =====
        function initBomExplorer() {
            renderBomSelector();
            document.getElementById('bomSearch').oninput = (e) => renderBomSelector(e.target.value.toLowerCase());
        }

        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => {
                t.classList.toggle('active', t.dataset.bomtab === tab);
            });
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }

        function renderBomSelector(filter = '') {
            const selector = document.getElementById('bomSelector');
            let data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            
            if (!data || data.length === 0) {
                selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available for this tab.</p>';
                return;
            }
            
            const filtered = data.filter(d => {
                const name = (d.partName || '').toLowerCase();
                const cat = (d.category || '').toLowerCase();
                return name.includes(filter) || cat.includes(filter);
            });
            
            selector.innerHTML = filtered.map((d, i) => `<div class="bom-item" data-index="${i}" onclick="showBomDetails(${i})">${d.partName || 'Unknown'}</div>`).join('');
        }

        function showBomDetails(index) {
            let data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            // Highlight selected item
            document.querySelectorAll('.bom-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
            
            document.getElementById('bomPartName').textContent = part.partName || 'Unknown';
            document.getElementById('bomCategory').textContent = part.category || '';
            
            let content = '';
            
            // Build content based on tab type
            if (currentBomTab === 'final') {
                content = `
                    <div class="bom-section">
                        <h4>Assembly Information</h4>
                        <div class="cost-breakdown">
                            <div class="cost-item"><span class="label">Parts per Package</span><span>${part.partsPerPackage || 'N/A'}</span></div>
                            <div class="cost-item"><span class="label">Sales Target</span><span>${formatCurrency(parseNumber(part.salesTarget))}</span></div>
                        </div>
                    </div>
                    ${part.component1 ? `
                    <div class="bom-section">
                        <h4>Components</h4>
                        <div class="component-list">
                            <div class="component-item">
                                <span class="name">${part.component1}</span>
                                <span class="details">Qty: ${part.component1Qty || 'N/A'}</span>
                            </div>
                        </div>
                    </div>` : ''}
                `;
            } else if (currentBomTab === 'sub') {
                content = `
                    <div class="bom-section">
                        <h4>Sub Assembly Information</h4>
                        <div class="cost-breakdown">
                            <div class="cost-item"><span class="label">Mold Name</span><span>${part.moldName || 'N/A'}</span></div>
                            <div class="cost-item"><span class="label">Total Cost</span><span>${formatCurrency(parseNumber(part.totalCost))}</span></div>
                        </div>
                    </div>
                    <div class="bom-section">
                        <h4>Components</h4>
                        <div class="component-list">
                            ${part.component1 ? `<div class="component-item"><span class="name">${part.component1}</span><span class="details">Qty: ${part.component1Qty || 'N/A'} | Cost: ${formatCurrency(parseNumber(part.component1Cost))}</span></div>` : ''}
                            ${part.component2 ? `<div class="component-item"><span class="name">${part.component2}</span><span class="details">Qty: ${part.component2Qty || 'N/A'} | Cost: ${formatCurrency(parseNumber(part.component2Cost))}</span></div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="bom-section">
                        <h4>Item Information</h4>
                        <div class="cost-breakdown">
                            <div class="cost-item"><span class="label">Description</span><span>${part.description || 'N/A'}</span></div>
                            <div class="cost-item"><span class="label">Cost</span><span>${formatCurrency(parseNumber(part.cost))}</span></div>
                            <div class="cost-item"><span class="label">Supplier</span><span>${part.supplier || 'N/A'}</span></div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('bomContent').innerHTML = content;
        }

        // ===== INITIALIZE =====
        window.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
