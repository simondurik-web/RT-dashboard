<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard - Data Inspection</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a202c;
            color: #fff;
        }
        .section {
            background: #2d3748;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #4a5568;
        }
        h2 {
            color: #63b3ed;
            margin-top: 0;
        }
        h3 {
            color: #48bb78;
        }
        .good { color: #48bb78; }
        .bad { color: #f56565; }
        pre {
            background: #1a202c;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #63b3ed;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border: 1px solid #4a5568;
        }
        th {
            background: #1a365d;
        }
    </style>
</head>
<body>
    <h1>üîç Dashboard Debug Mode</h1>
    <p>This will show you EXACTLY what data is being loaded from your Google Sheet</p>
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <h2>Loading data from Google Sheets...</h2>
    </div>

    <div id="results" style="display: none;"></div>

    <script>
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const CONFIG_GID = '912029812';

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            return { headers, data };
        }

        async function fetchSheetData(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to fetch GID ${gid}: ${response.status}`);
            const text = await response.text();
            return parseCSV(text);
        }

        function parseColumnMappings(mappingText) {
            if (!mappingText) return {};
            const lines = mappingText.split('\n');
            const mappings = {};
            lines.forEach(line => {
                const match = line.match(/(.+?)\s*‚Üí\s*(.+)/);
                if (match) {
                    mappings[match[2].trim()] = match[1].trim();
                }
            });
            return mappings;
        }

        async function debugDashboard() {
            const resultsDiv = document.getElementById('results');
            let html = '';

            try {
                // Load Dashboard Config
                html += '<div class="section">';
                html += '<h2>Step 1: Dashboard Config</h2>';
                
                const configResult = await fetchSheetData(CONFIG_GID);
                html += `<p class="good">‚úÖ Successfully loaded ${configResult.data.length} rows</p>`;
                html += '<h3>Config Data:</h3>';
                html += '<table><tr>';
                configResult.headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr>';
                configResult.data.slice(0, 10).forEach(row => {
                    html += '<tr>';
                    configResult.headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
                    html += '</tr>';
                });
                html += '</table>';

                // Parse config
                const config = {};
                configResult.data.forEach(row => {
                    if (row['Dashboard Name'] === 'P&L Dashboard' && row['GID Number']) {
                        const tabName = row['Tab Name'];
                        const gid = row['GID Number'];
                        const mappings = parseColumnMappings(row['Column Mappings']);
                        config[tabName] = { gid, mappings };
                    }
                });

                html += '<h3>Parsed Mappings:</h3>';
                html += '<pre>' + JSON.stringify(config, null, 2) + '</pre>';
                html += '</div>';

                // Load Orders Data
                if (config['Orders Data']) {
                    html += '<div class="section">';
                    html += '<h2>Step 2: Orders Data</h2>';
                    
                    const ordersResult = await fetchSheetData(config['Orders Data'].gid);
                    html += `<p class="good">‚úÖ Successfully loaded ${ordersResult.data.length} rows</p>`;
                    
                    html += '<h3>Available Columns:</h3>';
                    html += '<pre>' + JSON.stringify(ordersResult.headers, null, 2) + '</pre>';
                    
                    html += '<h3>First 5 Rows (RAW DATA):</h3>';
                    html += '<table><tr>';
                    ordersResult.headers.slice(0, 20).forEach(h => html += `<th>${h}</th>`);
                    html += '</tr>';
                    ordersResult.data.slice(0, 5).forEach(row => {
                        html += '<tr>';
                        ordersResult.headers.slice(0, 20).forEach(h => {
                            const value = row[h] || '';
                            html += `<td>${value}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';

                    // Show mapped data
                    html += '<h3>Mapped Data (What Dashboard Sees):</h3>';
                    const mappings = config['Orders Data'].mappings;
                    
                    html += '<p><strong>Expected Mappings:</strong></p>';
                    html += '<pre>' + JSON.stringify(mappings, null, 2) + '</pre>';

                    function applyMapping(row, mapping) {
                        const mapped = {};
                        for (const [fieldName, columnName] of Object.entries(mapping)) {
                            const value = row[columnName];
                            mapped[fieldName] = value !== undefined ? value : '‚ùå MISSING';
                        }
                        return mapped;
                    }

                    html += '<table><tr>';
                    Object.keys(mappings).forEach(field => html += `<th>${field}</th>`);
                    html += '</tr>';
                    
                    ordersResult.data.slice(0, 5).forEach(row => {
                        const mapped = applyMapping(row, mappings);
                        html += '<tr>';
                        Object.values(mapped).forEach(value => {
                            const isMissing = value === '‚ùå MISSING';
                            html += `<td class="${isMissing ? 'bad' : 'good'}">${value}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';

                    // Check specific columns
                    html += '<h3>Column Name Verification:</h3>';
                    html += '<table><tr><th>Expected Column</th><th>Actual Column</th><th>Status</th></tr>';
                    for (const [field, expectedCol] of Object.entries(mappings)) {
                        const exists = ordersResult.headers.includes(expectedCol);
                        const status = exists 
                            ? `<span class="good">‚úÖ Found</span>` 
                            : `<span class="bad">‚ùå Not Found</span>`;
                        html += `<tr><td>${field}</td><td>${expectedCol}</td><td>${status}</td></tr>`;
                        
                        if (!exists) {
                            // Find similar columns
                            const similar = ordersResult.headers.filter(h => 
                                h.toLowerCase().includes(expectedCol.toLowerCase().split(' ')[0])
                            );
                            if (similar.length > 0) {
                                html += `<tr><td colspan="3" style="background: #744210;">üí° Did you mean: ${similar.join(', ')}?</td></tr>`;
                            }
                        }
                    }
                    html += '</table>';

                    html += '</div>';
                } else {
                    html += '<div class="section">';
                    html += '<h2 class="bad">‚ùå Orders Data config not found!</h2>';
                    html += '</div>';
                }

            } catch (error) {
                html += '<div class="section">';
                html += `<h2 class="bad">‚ùå Error: ${error.message}</h2>`;
                html += '<pre>' + error.stack + '</pre>';
                html += '</div>';
            }

            document.getElementById('loading').style.display = 'none';
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Run on load
        window.addEventListener('DOMContentLoaded', debugDashboard);
    </script>
</body>
</html>
